<div class="container-xl photo-page-shell">
  <div class="photo-page-layout" [class.edit-mode]="isEditMode()">

    <!-- SidebarÔºàÊää open ÁãÄÊÖãÂÇ≥ÂÖ•Ôºâ -->
    <app-photo-sidebar [class.sidebar-open]="isSidebarOpen()" (openChange)="isSidebarOpen.set($event)"
      (tagSelectionChange)="onTagSelectionChange($event)" class="photo-sidebar-wrapper">
    </app-photo-sidebar>

    <!-- ÊâãÊ©ü sidebar ËÉåÊôØÈÅÆÁΩ© -->
    @if (isSidebarOpen()) {
    <div class="sidebar-backdrop" (click)="toggleSidebar()"></div>
    }

    <div class="photo-main-content">
      <!-- Header -->
      <div class="page-header d-print-none">
        <div class="row g-2 align-items-center">
          <div class="col">
            <button class="btn btn-outline-primary d-lg-none me-2" (click)="toggleSidebar()" title="ÈñãÂïüÁØ©ÈÅ∏">
              <i class="ti ti-filter"></i>
            </button>

            <h2 class="page-title d-inline-block">
              <i class="ti ti-photo me-2"></i>
              ÊàëÁöÑÁÖßÁâá
            </h2>

            @if (hasFilter()) {
            <span class="badge bg-primary-lt ms-2">
              <i class="ti ti-filter-filled me-1"></i>
              Â∑≤ÁØ©ÈÅ∏ {{ filterTagIds().length }} ÂÄãÊ®ôÁ±§
            </span>
            }

            <div class="text-secondary mt-1">
              @if (hasFilter()) {
              <span>Á¨¶ÂêàÁØ©ÈÅ∏Ê¢ù‰ª∂ÁöÑÁÖßÁâá</span>
              <button class="btn btn-sm btn-link text-danger p-0 ms-2" (click)="clearFilter()">
                <i class="ti ti-x"></i>
                Ê∏ÖÈô§ÁØ©ÈÅ∏
              </button>
              } @else {
              <span>ÁÆ°ÁêÜÊÇ®‰∏äÂÇ≥ÁöÑÊâÄÊúâÁÖßÁâá</span>
              }
            </div>
          </div>

          <!-- Âè≥ÂÅ¥ÔºöÁ∑®ËºØ + ‰∏äÂÇ≥ -->
          <div class="col-auto ms-auto">
            <div class="btn-list">
              <button type="button" class="btn" [class.btn-outline-primary]="!isEditMode()"
                [class.btn-primary]="isEditMode()" (click)="toggleEditMode()">
                <i class="ti" [class.ti-edit]="!isEditMode()" [class.ti-check]="isEditMode()"></i>
                {{ isEditMode() ? 'ÂÆåÊàêÁ∑®ËºØ' : 'Á∑®ËºØ' }}
              </button>

              <a routerLink="/photo-classify" class="btn btn-primary">
                <i class="ti ti-upload me-2"></i>
                ‰∏äÂÇ≥ÁÖßÁâá
              </a>
            </div>
          </div>
        </div>
      </div>

      <div class="page-body">

        <!-- Â∑•ÂÖ∑ÂàóÔºöÂè™Âú®Á∑®ËºØÊ®°ÂºèÈ°ØÁ§∫ -->
        @if (isEditMode() && photos() && hasPhotos()) {
        <div class="card mb-3">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-auto">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" [checked]="allSelected()" (change)="toggleSelectAll()"
                    id="selectAll">
                  <label class="form-check-label" for="selectAll">
                    @if (selectedCount() > 0) {
                    <span class="text-primary">Â∑≤ÈÅ∏Âèñ {{ selectedCount() }} ÂºµÁÖßÁâá</span>
                    } @else {
                    <span>ÂÖ®ÈÅ∏</span>
                    }
                  </label>
                </div>
              </div>

              @if (selectedCount() > 0) {
              <div class="col-auto">
                <!-- üÜï ÊâπÊ¨°Ê∑ªÂä†Ê®ôÁ±§ÊåâÈàï -->
                <button class="btn btn-primary btn-sm me-2" (click)="openBatchAddTagsDialog()">
                  <i class="ti ti-tag me-2"></i>
                  Ê∑ªÂä†Ê®ôÁ±§ ({{ selectedCount() }})
                </button>

                <!-- ÂéüÊúâÔºöÂà™Èô§ÈÅ∏ÂèñÊåâÈàï -->
                <button class="btn btn-danger btn-sm" (click)="deleteSelectedPhotos()">
                  <i class="ti ti-trash me-2"></i>
                  Âà™Èô§ÈÅ∏Âèñ ({{ selectedCount() }})
                </button>
              </div>
              }

              <div class="col-auto ms-auto">
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-sm" [class.btn-primary]="viewMode() === 'grid'"
                    [class.btn-outline-primary]="viewMode() !== 'grid'" (click)="viewMode.set('grid')" title="Á∂≤Ê†ºÊ™¢Ë¶ñ">
                    <i class="ti ti-layout-grid"></i>
                  </button>
                  <button type="button" class="btn btn-sm" [class.btn-primary]="viewMode() === 'list'"
                    [class.btn-outline-primary]="viewMode() !== 'list'" (click)="viewMode.set('list')" title="ÂàóË°®Ê™¢Ë¶ñ">
                    <i class="ti ti-list"></i>
                  </button>
                </div>
              </div>

              <div class="col-auto">
                <div class="text-secondary">ÂÖ± {{ totalCount() }} ÂºµÁÖßÁâá</div>
              </div>
            </div>
          </div>
        </div>
        }

        <!-- Loading -->
        @if (isLoading()) {
        <div class="card">
          <div class="card-body text-center py-5">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">ËºâÂÖ•‰∏≠...</span>
            </div>
            <div class="text-secondary">ËºâÂÖ•ÁÖßÁâá‰∏≠...</div>
          </div>
        </div>
        }

        <!-- Grid -->
        @if (!isLoading() && hasPhotos() && viewMode() === 'grid') {
        <div class="photo-grid">
          @for (photo of photos(); track photo.photoId) {
          <div class="photo-card" [class.selected]="isEditMode() && selectedPhotos().has(photo.photoId)"
            (click)="onPhotoClick(photo)">

            <!-- Á∑®ËºØÊ®°ÂºèÊâçÈ°ØÁ§∫ÂãæÈÅ∏ -->
            @if (isEditMode()) {
            <div class="photo-checkbox">
              <input type="checkbox" class="form-check-input" [checked]="selectedPhotos().has(photo.photoId)"
                (click)="$event.stopPropagation()" (change)="togglePhotoSelection(photo.photoId)">
            </div>

            <div class="photo-actions">
              <button class="btn btn-sm btn-ghost-danger" (click)="deletePhoto(photo.photoId, $event)" title="Âà™Èô§">
                <i class="ti ti-trash"></i>
              </button>
            </div>
            }

            <div class="photo-thumbnail">
              <img [src]="getThumbnailUrl(photo)" [alt]="photo.fileName" loading="lazy">
            </div>

            <div class="photo-info">
              <div class="photo-filename" [title]="photo.fileName">{{ photo.fileName }}</div>
              <div class="photo-meta">
                <span class="meta-item">
                  <i class="ti ti-calendar"></i>
                  {{ formatDate(photo.dateTaken || photo.uploadedAt) }}
                </span>
              </div>

              @if (photo.tags && photo.tags.length > 0) {
              <div class="photo-tags">
                @for (tag of photo.tags.slice(0, 3); track tag) {
                <span class="badge bg-blue-lt">{{ tag }}</span>
                }
                @if (photo.tags.length > 3) {
                <span class="badge bg-secondary-lt">+{{ photo.tags.length - 3 }}</span>
                }
              </div>
              }
            </div>
          </div>
          }
        </div>
        }

        <!-- List -->
        @if (!isLoading() && hasPhotos() && viewMode() === 'list') {
        <div class="card">
          <div class="table-responsive">
            <table class="table table-vcenter card-table">
              <thead>
                <tr>
                  @if (isEditMode()) { <th class="w-1"></th> }
                  <th>ÁÖßÁâá</th>
                  <th>Ê™îÊ°àÂêçÁ®±</th>
                  <th>ÊãçÊîùÊôÇÈñì</th>
                  <th>Ê®ôÁ±§</th>
                  @if (isEditMode()) { <th class="w-1"></th> }
                </tr>
              </thead>

              <tbody>
                @for (photo of photos(); track photo.photoId) {
                <tr class="photo-row" [class.table-active]="isEditMode() && selectedPhotos().has(photo.photoId)"
                  (click)="onPhotoClick(photo)">

                  @if (isEditMode()) {
                  <td (click)="$event.stopPropagation()">
                    <input type="checkbox" class="form-check-input" [checked]="selectedPhotos().has(photo.photoId)"
                      (change)="togglePhotoSelection(photo.photoId)">
                  </td>
                  }

                  <td>
                    <div class="list-thumbnail">
                      <img [src]="getThumbnailUrl(photo)" [alt]="photo.fileName">
                    </div>
                  </td>
                  <td>
                    <div class="text-truncate" style="max-width: 300px;" [title]="photo.fileName">
                      {{ photo.fileName }}
                    </div>
                  </td>
                  <td>
                    <span class="text-secondary">{{ formatDate(photo.dateTaken || photo.uploadedAt) }}</span>
                  </td>
                  <td>
                    @if (photo.tags && photo.tags.length > 0) {
                    <div class="d-flex flex-wrap gap-1">
                      @for (tag of photo.tags.slice(0, 5); track tag) {
                      <span class="badge bg-blue-lt">{{ tag }}</span>
                      }
                      @if (photo.tags.length > 5) {
                      <span class="badge bg-secondary-lt">+{{ photo.tags.length - 5 }}</span>
                      }
                    </div>
                    } @else {
                    <span class="text-secondary">-</span>
                    }
                  </td>

                  @if (isEditMode()) {
                  <td (click)="$event.stopPropagation()">
                    <button class="btn btn-sm btn-ghost-danger" (click)="deletePhoto(photo.photoId, $event)" title="Âà™Èô§">
                      <i class="ti ti-trash"></i>
                    </button>
                  </td>
                  }
                </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
        }

        <!-- Pagination -->
        @if (!isLoading() && hasPhotos() && totalPages() > 1) {
        <div class="card mt-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <button class="btn btn-outline-primary" [disabled]="currentPage() === 1" (click)="previousPage()">
                <i class="ti ti-chevron-left me-2"></i>
                ‰∏ä‰∏ÄÈ†Å
              </button>

              <ul class="pagination pagination-sm m-0">
                @if (getPageRange()[0] > 1) {
                <li class="page-item"><a class="page-link" (click)="goToPage(1)">1</a></li>
                @if (getPageRange()[0] > 2) {
                <li class="page-item disabled"><span class="page-link">...</span></li>
                }
                }

                @for (page of getPageRange(); track page) {
                <li class="page-item" [class.active]="page === currentPage()">
                  <a class="page-link" (click)="goToPage(page)">{{ page }}</a>
                </li>
                }

                @if (getPageRange()[getPageRange().length - 1] < totalPages()) { @if
                  (getPageRange()[getPageRange().length - 1] < totalPages() - 1) { <li class="page-item disabled"><span
                    class="page-link">...</span></li>
                  }
                  <li class="page-item"><a class="page-link" (click)="goToPage(totalPages())">{{ totalPages() }}</a>
                  </li>
                  }
              </ul>

              <button class="btn btn-outline-primary" [disabled]="currentPage() === totalPages()" (click)="nextPage()">
                ‰∏ã‰∏ÄÈ†Å <i class="ti ti-chevron-right ms-2"></i>
              </button>
            </div>
          </div>
        </div>
        }

        <!-- Empty -->
        @if (!isLoading() && !hasPhotos()) {
        <div class="empty">
          <div class="empty-img">
            <img src="https://tabler.io/static/illustrations/undraw_photo_album_re_bhes.svg" height="128" alt="">
          </div>
          @if (hasFilter()) {
          <p class="empty-title">Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁÖßÁâá</p>
          <p class="empty-subtitle text-secondary">Ë´ãÂòóË©¶Ë™øÊï¥ÁØ©ÈÅ∏Ê¢ù‰ª∂</p>
          <div class="empty-action">
            <button class="btn btn-primary" (click)="clearFilter()">
              <i class="ti ti-x me-2"></i>Ê∏ÖÈô§ÁØ©ÈÅ∏
            </button>
          </div>
          } @else {
          <p class="empty-title">ÈÇÑÊ≤íÊúâÁÖßÁâá</p>
          <p class="empty-subtitle text-secondary">ÈñãÂßã‰∏äÂÇ≥ÊÇ®ÁöÑÁ¨¨‰∏ÄÂºµÁÖßÁâáÂêßÔºÅ</p>
          <div class="empty-action">
            <a routerLink="/photo-classify" class="btn btn-primary">
              <i class="ti ti-upload me-2"></i>‰∏äÂÇ≥ÁÖßÁâá
            </a>
          </div>
          }
        </div>
        }

      </div>
    </div>

    <!-- Ë©≥Á¥∞Ë≥áË®ä ModalÔºàÈùûÁ∑®ËºØÊ®°Âºè‰∏ãÈªûÁÖßÁâáÈñãÔºâ -->
    @if (activePhoto()) {
    <div class="photo-detail-backdrop" (click)="closePhotoDetail()"></div>

    <div class="photo-detail-modal" role="dialog" aria-modal="true" (click)="$event.stopPropagation()">
      <div class="photo-detail-header">
        <div class="title">
          <i class="ti ti-photo"></i>
          <span class="text-truncate">{{ activePhoto()!.fileName }}</span>
        </div>

        <button class="btn btn-sm btn-ghost-secondary" (click)="closePhotoDetail()" title="ÈóúÈñâ">
          <i class="ti ti-x"></i>
        </button>
      </div>

      <div class="photo-detail-body">
        <div class="detail-image">
          <img [src]="getThumbnailUrl(activePhoto()!)" [alt]="activePhoto()!.fileName">
        </div>

        <div class="detail-info">
          <div class="info-row">
            <span class="label">Ê™îÂêç</span>
            <span class="value">{{ activePhoto()!.fileName }}</span>
          </div>

          <div class="info-row">
            <span class="label">ÊôÇÈñì</span>
            <span class="value">{{ formatDate(activePhoto()!.dateTaken || activePhoto()!.uploadedAt) }}</span>
          </div>

          <div class="info-row">
            <span class="label">Ê®ôÁ±§</span>
            <span class="value">
              @if (activePhoto()!.tags?.length) {
              <span class="d-flex flex-wrap gap-1">
                @for (tag of activePhoto()!.tags; track tag) {
                <span class="badge bg-blue-lt">{{ tag }}</span>
                }
              </span>
              } @else {
              <span class="text-secondary">-</span>
              }
            </span>
          </div>
        </div>
      </div>

      <div class="photo-detail-footer">
        <button class="btn btn-outline-primary" (click)="toggleEditMode(); closePhotoDetail()">
          <i class="ti ti-edit me-2"></i>ÈÄ≤ÂÖ•Á∑®ËºØ
        </button>

        <button class="btn btn-danger" (click)="deletePhoto(activePhoto()!.photoId, $event)">
          <i class="ti ti-trash me-2"></i>Âà™Èô§
        </button>
      </div>
    </div>
    }



  </div>
  <!-- üÜï ÊâπÊ¨°Ê∑ªÂä†Ê®ôÁ±§Â∞çË©±Ê°Ü -->

  @if (isBatchAddTagsDialogOpen()) {
  <app-batch-add-tags-dialog [selectedPhotoCount]="selectedCount()" (confirm)="handleBatchAddTags($event)"
    (cancel)="closeBatchAddTagsDialog()">
  </app-batch-add-tags-dialog>
  }
</div>
