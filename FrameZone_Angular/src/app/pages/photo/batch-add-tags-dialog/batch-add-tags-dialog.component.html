<!-- èƒŒæ™¯é®ç½© -->
<div class="dialog-backdrop" (click)="onBackdropClick()"></div>

<!-- å°è©±æ¡†ä¸»é«” -->
<div class="dialog-container" role="dialog" aria-modal="true" aria-labelledby="dialog-title" (click)="onDialogClick($event)">

  <!-- Header -->
  <div class="dialog-header">
    <h3 class="dialog-title" id="dialog-title">
      <i class="ti ti-tag me-2"></i>
      æ‰¹æ¬¡æ·»åŠ æ¨™ç±¤
    </h3>

    <button type="button" class="btn-close" (click)="onCancel()" aria-label="é—œé–‰" title="é—œé–‰">
      <i class="ti ti-x"></i>
    </button>
  </div>

  <!-- Body -->
  <div class="dialog-body">

    <!-- ç…§ç‰‡æ•¸é‡æç¤º -->
    <div class="photo-count-hint">
      <i class="ti ti-photo me-2"></i>
      ç‚º <strong>{{ selectedPhotoCount }}</strong> å¼µç…§ç‰‡æ·»åŠ æ¨™ç±¤
    </div>

    <!-- æœå°‹æ¡† -->
    <div class="search-box">
      <div class="input-icon">
        <span class="input-icon-addon">
          <i class="ti ti-search"></i>
        </span>
        <input
          #searchInput
          type="text"
          class="form-control"
          placeholder="æœå°‹æ¨™ç±¤..."
          [value]="searchKeyword()"
          (input)="onSearchInput($any($event.target).value)"
          [disabled]="isSubmitting()">
      </div>
    </div>

    <!-- æœå°‹ä¸­ç‹€æ…‹ -->
    @if (isSearching()) {
      <div class="search-status">
        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
          <span class="visually-hidden">æœå°‹ä¸­...</span>
        </div>
        <span class="text-secondary">æœå°‹ä¸­...</span>
      </div>
    }

    <!-- æœå°‹çµæœå€åŸŸ -->
    @if (hasSearchResults() && !isSearching()) {
      <div class="search-results-section">
        <div class="section-header">
          <span class="section-title">æœå°‹çµæœ</span>
          <span class="badge bg-secondary-lt">{{ searchResults().length }}</span>
        </div>

        <div class="tag-list">
          @for (tag of searchResults(); track tag.tagId) {
            <div
              class="tag-item"
              [class.selected]="isTagSelected(tag.tagId)"
              (click)="toggleTagSelection(tag)">

              <!-- å‹¾é¸æ¡† -->
              <div class="tag-checkbox">
                <input
                  type="checkbox"
                  class="form-check-input"
                  [checked]="isTagSelected(tag.tagId)"
                  (click)="$event.stopPropagation()"
                  readonly>
              </div>

              <!-- æ¨™ç±¤è³‡è¨Š -->
              <div class="tag-info">
                <div class="tag-name">
                  <span class="tag-icon">{{ getTagIcon(tag) }}</span>
                  <span class="tag-text">{{ tag.tagName }}</span>
                </div>
                <div class="tag-meta">
                  <span class="tag-type">{{ getTagTypeText(tag) }}</span>
                  @if (tag.photoCount !== undefined && tag.photoCount > 0) {
                    <span class="tag-count">
                      <i class="ti ti-photo"></i>
                      {{ tag.photoCount }}
                    </span>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- ç©ºç‹€æ…‹ - é¡¯ç¤ºã€Œå»ºç«‹æ–°æ¨™ç±¤ã€ -->
    @if (showEmptyState() && showCreateNewTag() && !isSearching()) {
      <div class="empty-state">
        <div class="empty-icon">
          <i class="ti ti-tag-off"></i>
        </div>
        <p class="empty-text">æ‰¾ä¸åˆ°åŒ¹é…çš„æ¨™ç±¤</p>

        <!-- ğŸ†• çˆ¶æ¨™ç±¤é¸æ“‡ï¼ˆå»ºç«‹éšå±¤å¼æ¨™ç±¤ï¼‰ -->
        <div class="parent-tag-select">
          <label class="form-label">å»ºç«‹åˆ°çˆ¶æ¨™ç±¤ï¼ˆå¯é¸ï¼‰</label>

          <select class="form-select" [(ngModel)]="selectedParentTagId" [disabled]="isSubmitting()">
            <option [ngValue]="null">ï¼ˆç„¡ï¼‰å»ºç«‹ç‚ºé ‚å±¤æ¨™ç±¤</option>
            @for (group of parentTagGroups(); track group.categoryName) {
              <optgroup [label]="group.categoryName">
                @for (opt of group.options; track opt.tagId) {
                  <option [ngValue]="opt.tagId">{{ opt.label }}</option>
                }
              </optgroup>
            }
          </select>

          <div class="form-hint">
            ä¾‹ï¼šè¦æŠŠã€Œå…”å­ã€æ”¾åˆ°ã€Œå¯µç‰©ã€åº•ä¸‹ï¼Œå…ˆé¸ã€Œå¯µç‰©ã€ã€‚
          </div>
        </div>

        <button
          type="button"
          class="btn btn-primary btn-sm"
          (click)="createNewTag()"
          [disabled]="isSubmitting()">
          <i class="ti ti-plus me-2"></i>
          å»ºç«‹æ–°æ¨™ç±¤ "{{ searchKeyword() }}"
        </button>
      </div>
    }

    <!-- åˆå§‹æç¤ºï¼ˆç„¡æœå°‹æ™‚ï¼‰ -->
    @if (!searchKeyword().trim() && !isSearching()) {
      <div class="hint-text">
        <i class="ti ti-info-circle me-2"></i>
        è¼¸å…¥é—œéµå­—æœå°‹æ¨™ç±¤ï¼Œæˆ–ç›´æ¥å»ºç«‹æ–°æ¨™ç±¤
      </div>
    }

    <!-- å·²é¸æ¨™ç±¤å€åŸŸ -->
    @if (totalSelectedCount() > 0) {
      <div class="selected-tags-section">
        <div class="section-header">
          <span class="section-title">å·²é¸æ¨™ç±¤</span>
          <span class="badge bg-primary">{{ totalSelectedCount() }}</span>
        </div>

        <div class="selected-tags-list">

          <!-- å·²å­˜åœ¨çš„æ¨™ç±¤ -->
          @for (tag of selectedTags(); track tag.tagId) {
            <span class="badge-tag badge-existing">
              <span class="badge-icon">{{ getTagIcon(tag) }}</span>
              <span class="badge-text">{{ tag.tagName }}</span>
              <button
                type="button"
                class="badge-remove"
                (click)="removeSelectedTag(tag.tagId)"
                [disabled]="isSubmitting()"
                title="ç§»é™¤">
                <i class="ti ti-x"></i>
              </button>
            </span>
          }

          <!-- å¾…å»ºç«‹çš„æ–°æ¨™ç±¤ -->
          @for (newTag of newTagsToCreate(); track $index) {
            <span class="badge-tag badge-new">
              <span class="badge-icon">âœ¨</span>
              <span class="badge-text">{{ newTag.tagName }}</span>
              <span class="badge-label">(æ–°)</span>
              <button
                type="button"
                class="badge-remove"
                (click)="removeNewTag($index)"
                [disabled]="isSubmitting()"
                title="ç§»é™¤">
                <i class="ti ti-x"></i>
              </button>
            </span>
          }

        </div>
      </div>
    }

  </div>

  <!-- Footer -->
  <div class="dialog-footer">
    <button
      type="button"
      class="btn btn-outline-secondary"
      (click)="onCancel()"
      [disabled]="isSubmitting()">
      å–æ¶ˆ
    </button>

    <button
      type="button"
      class="btn btn-primary"
      (click)="onConfirm()"
      [disabled]="!canSubmit()">
      @if (isSubmitting()) {
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        <span>è™•ç†ä¸­...</span>
      } @else {
        <i class="ti ti-check me-2"></i>
        <span>ç¢ºèªæ·»åŠ </span>
        @if (totalSelectedCount() > 0) {
          <span class="ms-1">({{ totalSelectedCount() }})</span>
        }
      }
    </button>
  </div>

</div>
