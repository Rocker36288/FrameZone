<div class="container-xl">
  <!-- 頁面標題 -->
  <div class="page-header d-print-none">
    <div class="row g-2 align-items-center">
      <div class="col">
        <h2 class="page-title">
          <i class="ti ti-photo-up me-2"></i>
          照片上傳與分類
        </h2>
        <div class="text-secondary mt-1">
          上傳照片後系統將自動解析 EXIF 資訊並進行智慧分類
        </div>
      </div>

      <!-- 操作按鈕區 -->
      <div class="col-auto ms-auto">
        <div class="btn-list">
          <button class="btn btn-primary btn-pulse"
                  [disabled]="isUploading() || pendingFilesCount() === 0"
                  (click)="startBatchUpload()">
            @if (isUploading()) {
            <span class="spinner-border spinner-border-sm me-2"></span>
            上傳中...
            } @else {
            <i class="ti ti-upload me-2"></i>
            開始批次上傳 ({{ pendingFilesCount() }})
            }
          </button>

          <button class="btn btn-outline-danger"
                  [disabled]="isUploading()"
                  (click)="clearAll()">
            <i class="ti ti-trash me-2"></i>
            清空列表
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="page-body">
    <!-- 統計卡片區 - 漸層版本 -->
    <div class="row g-3 mb-3">
      <div class="col-sm-6 col-lg-3">
        <div class="card card-sm stats-card stats-card-gradient-blue">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-auto">
                <div class="stats-icon">
                  <i class="ti ti-photo"></i>
                </div>
              </div>
              <div class="col">
                <div class="stats-label">總檔案數</div>
                <div class="stats-sublabel">Total Files</div>
              </div>
              <div class="col-auto">
                <div class="stats-value">{{ uploadFiles().length }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-sm-6 col-lg-3">
        <div class="card card-sm stats-card stats-card-gradient-success">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-auto">
                <div class="stats-icon">
                  <i class="ti ti-check"></i>
                </div>
              </div>
              <div class="col">
                <div class="stats-label">上傳成功</div>
                <div class="stats-sublabel">Success</div>
              </div>
              <div class="col-auto">
                <div class="stats-value stats-success">{{ successCount() }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-sm-6 col-lg-3">
        <div class="card card-sm stats-card stats-card-gradient-danger">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-auto">
                <div class="stats-icon">
                  <i class="ti ti-x"></i>
                </div>
              </div>
              <div class="col">
                <div class="stats-label">上傳失敗</div>
                <div class="stats-sublabel">Failed</div>
              </div>
              <div class="col-auto">
                <div class="stats-value stats-danger">{{ failedCount() }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-sm-6 col-lg-3">
        <div class="card card-sm stats-card stats-card-gradient-secondary">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-auto">
                <div class="stats-icon">
                  <i class="ti ti-clock"></i>
                </div>
              </div>
              <div class="col">
                <div class="stats-label">等待上傳</div>
                <div class="stats-sublabel">Pending</div>
              </div>
              <div class="col-auto">
                <div class="stats-value stats-pending">{{ pendingFilesCount() }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 主要內容區：左右分欄 -->
    <div class="row g-3">
      <!-- 左側：上傳區域 -->
      <div class="col-lg-8">
        <div class="card upload-card">
          <div class="card-body">
            <div class="upload-zone"
                 [class.dragging]="isDragging()"
                 [class.has-files]="uploadFiles().length > 0"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)"
                 (drop)="onDrop($event)">
              <div class="text-center">
                <!-- 單圖示 -->
                <div class="upload-icon-wrapper mb-3">
                  <i class="ti ti-cloud-upload upload-icon-primary"></i>
                </div>

                @if (isDragging()) {
                <h3 class="mb-2 text-primary">
                  <i class="ti ti-hand-stop me-2"></i>
                  釋放以上傳檔案
                </h3>
                } @else {
                <h3 class="mb-2">拖放照片到這裡</h3>
                <p class="text-secondary mb-3">
                  或點擊下方按鈕選擇檔案
                </p>
                }

                <label class="btn btn-primary btn-lg btn-upload">
                  <i class="ti ti-file-plus me-2"></i>
                  選擇照片
                  <input type="file"
                         multiple
                         accept="image/*,.heic,.heif,.jpg,.jpeg,.png,.gif,.bmp"
                         (change)="onFileSelect($event)"
                         style="display:none;">
                </label>

                <!-- 支援格式和限制 -->
                <div class="upload-info mt-4">
                  <div class="upload-info-item">
                    <i class="ti ti-file-type-jpg"></i>
                    <span>JPG, PNG, HEIC, GIF, BMP, WebP</span>
                  </div>
                  <div class="upload-info-item">
                    <i class="ti ti-upload"></i>
                    <span>最大 {{ uploadLimits.maxFileSize }}MB / 張</span>
                  </div>
                  <div class="upload-info-item">
                    <i class="ti ti-files"></i>
                    <span>單次最多 {{ uploadLimits.maxBatchCount }} 張</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 右側：上傳清單 -->
      <div class="col-lg-4">
        <div class="card upload-list-card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="ti ti-list me-2"></i>
              上傳清單
            </h3>
            <!-- 快捷操作按鈕 -->
            @if (uploadFiles().length > 0) {
            <div class="card-actions">
              <div class="dropdown">
                <button class="btn btn-sm btn-ghost-secondary dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown">
                  <i class="ti ti-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" (click)="removeSuccessFiles()">
                      <i class="ti ti-check me-2"></i>
                      移除已成功
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" (click)="retryFailedFiles()">
                      <i class="ti ti-refresh me-2"></i>
                      重試失敗項目
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a class="dropdown-item text-danger" (click)="clearAll()">
                      <i class="ti ti-trash me-2"></i>
                      清空全部
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            }
          </div>

          <!-- 整體進度條 -->
          @if (isUploading() && totalFiles() > 0) {
          <div class="overall-progress">
            <div class="d-flex justify-content-between align-items-center px-3 pt-3 pb-2">
              <span class="text-muted small">整體進度</span>
              <span class="text-primary fw-bold">{{ successCount() }}/{{ totalFiles() }}</span>
            </div>
            <div class="progress overall-progress-bar mb-3" style="height: 6px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated bg-gradient-primary"
                   role="progressbar"
                   [style.width.%]="(successCount() / totalFiles()) * 100">
              </div>
            </div>
          </div>
          }

          <!-- 篩選按鈕 -->
          @if (uploadFiles().length > 0) {
          <div class="list-filters px-3 pb-2">
            <div class="btn-group btn-group-sm w-100" role="group">
              <button class="btn"
                      [class.btn-primary]="filterStatus() === 'all'"
                      [class.btn-outline-primary]="filterStatus() !== 'all'"
                      (click)="setFilterStatus('all')">
                全部 ({{ uploadFiles().length }})
              </button>
              <button class="btn"
                      [class.btn-secondary]="filterStatus() === 'pending'"
                      [class.btn-outline-secondary]="filterStatus() !== 'pending'"
                      (click)="setFilterStatus('pending')">
                等待 ({{ pendingFilesCount() }})
              </button>
              <button class="btn"
                      [class.btn-success]="filterStatus() === 'success'"
                      [class.btn-outline-success]="filterStatus() !== 'success'"
                      (click)="setFilterStatus('success')">
                成功 ({{ successCount() }})
              </button>
              <button class="btn"
                      [class.btn-danger]="filterStatus() === 'error'"
                      [class.btn-outline-danger]="filterStatus() !== 'error'"
                      (click)="setFilterStatus('error')">
                失敗 ({{ failedCount() }})
              </button>
            </div>
          </div>
          }

          <div class="card-body p-0">
            @if (filteredFiles().length > 0) {
            <div class="upload-list">
              @for (fileItem of filteredFiles(); track fileItem.fileName; let i = $index) {
              <div class="upload-list-item"
                   [class.upload-success]="fileItem.status === 'success'"
                   [class.upload-error]="fileItem.status === 'error'">
                <div class="d-flex align-items-start gap-3">
                  <!-- 縮圖帶類型圖示 -->
                  <div class="upload-list-thumbnail">
                    @if (fileItem.preview) {
                    <img [src]="fileItem.preview" alt="preview">
                    <div class="file-type-badge" [class]="getFileTypeBadgeClass(fileItem.fileName)">
                      <i [class]="getFileTypeIcon(fileItem.fileName)"></i>
                    </div>
                    } @else {
                    <div class="upload-list-thumbnail-placeholder">
                      <i [class]="getFileTypeIcon(fileItem.fileName)"></i>
                    </div>
                    }
                  </div>

                  <!-- 檔案資訊 -->
                  <div class="flex-fill">
                    <div class="upload-list-filename" [title]="fileItem.fileName">
                      {{ fileItem.fileName }}
                    </div>
                    <div class="upload-list-filesize">
                      {{ formatFileSize(fileItem.fileSize) }}
                    </div>
                    <div class="upload-list-status">
                      <i [class]="getStatusIconClass(fileItem.status)"></i>
                      <span [class]="getStatusTextClass(fileItem.status)">
                        {{ getStatusText(fileItem.status) }}
                      </span>
                    </div>
                    @if (fileItem.error) {
                    <div class="upload-list-error">
                      <i class="ti ti-alert-circle me-1"></i>
                      {{ fileItem.error }}
                    </div>
                    }
                  </div>

                  <!-- 操作按鈕 -->
                  <div class="upload-list-actions">
                    @if (fileItem.status === 'uploading') {
                    <div class="spinner-border spinner-border-sm text-primary"></div>
                    } @else if (fileItem.status === 'success') {
                    <button class="btn btn-sm btn-icon btn-ghost-success"
                            title="已完成">
                      <i class="ti ti-check"></i>
                    </button>
                    } @else {
                    <button class="btn btn-sm btn-icon btn-ghost-danger"
                            (click)="removeFile(i)"
                            title="移除">
                      <i class="ti ti-trash"></i>
                    </button>
                    }
                  </div>
                </div>

                <!-- 進度條 -->
                @if (fileItem.status === 'uploading' && fileItem.progress > 0) {
                <div class="progress mt-2" style="height: 4px;">
                  <div class="progress-bar progress-bar-striped progress-bar-animated"
                       [style.width.%]="fileItem.progress">
                  </div>
                </div>
                }
              </div>
              }
            </div>
            } @else if (uploadFiles().length > 0) {
            <!-- 篩選後無結果 -->
            <div class="empty-list">
              <i class="ti ti-filter-off text-muted mb-2"></i>
              <p class="text-secondary mb-0">此狀態下沒有檔案</p>
            </div>
            } @else {
            <!-- 完全空狀態 -->
            <div class="empty-state">
              <div class="empty-state-icon">
                <i class="ti ti-cloud-upload"></i>
              </div>
              <h4 class="mb-2">開始上傳您的照片</h4>
              <p class="text-muted mb-4">支援批次上傳，最多 {{ uploadLimits.maxBatchCount }} 張照片</p>

              <!-- 功能特點 -->
              <div class="empty-state-features">
                <div class="feature-item">
                  <div class="feature-icon">
                    <i class="ti ti-sparkles"></i>
                  </div>
                  <div class="feature-text">AI 自動分類</div>
                </div>
                <div class="feature-item">
                  <div class="feature-icon">
                    <i class="ti ti-file-info"></i>
                  </div>
                  <div class="feature-text">EXIF 解析</div>
                </div>
                <div class="feature-item">
                  <div class="feature-icon">
                    <i class="ti ti-cloud"></i>
                  </div>
                  <div class="feature-text">雲端儲存</div>
                </div>
              </div>
            </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
