<div class="page page-center">
  <div class="container container-tight py-4">
    <div class="card card-md">
      <div class="card-body">
        <h2 class="h2 text-center mb-4">重設密碼</h2>

        <!-- 驗證 Token 中的載入提示 -->
        @if (isValidatingToken) {
          <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">驗證中...</span>
            </div>
            <p class="text-muted">正在驗證重設密碼連結...</p>
          </div>
        }

        <!-- Token 無效的錯誤訊息 -->
        @if (!isValidatingToken && !isTokenValid) {
          <div class="text-center py-4">
            <div class="alert alert-danger" role="alert">
              <div class="d-flex align-items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M12 9v4" />
                  <path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" />
                  <path d="M12 16h.01" />
                </svg>
                <div class="ms-2">{{ errorMessage }}</div>
              </div>
            </div>
            <a routerLink="/forgot-password" class="btn btn-primary">
              重新取得重設連結
            </a>
          </div>
        }

        <!-- 重設密碼表單 -->
        @if (!isValidatingToken && isTokenValid) {
          <!-- 成功訊息 -->
          @if (successMessage) {
            <div class="alert alert-success alert-dismissible mb-3" role="alert">
              <div class="d-flex align-items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M5 12l5 5l10 -10" />
                </svg>
                <div class="ms-2">{{ successMessage }}</div>
              </div>
              <button type="button" class="btn-close" (click)="dismissSuccess()" aria-label="Close"></button>
            </div>
          }

          <!-- 錯誤訊息 -->
          @if (errorMessage) {
            <div class="alert alert-danger alert-dismissible mb-3" role="alert">
              <div class="d-flex align-items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M12 9v4" />
                  <path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" />
                  <path d="M12 16h.01" />
                </svg>
                <div class="ms-2">{{ errorMessage }}</div>
              </div>
              <button type="button" class="btn-close" (click)="dismissError()" aria-label="Close"></button>
            </div>
          }

          <p class="text-muted mb-4">請輸入您的新密碼。密碼長度需為 6-50 個字元，且至少包含一個字母和一個數字。</p>

          <form [formGroup]="resetForm" (ngSubmit)="onSubmit()">
            <!-- 新密碼欄位 -->
            <div class="mb-3">
              <label class="form-label required">新密碼</label>
              <div class="input-group input-group-flat">
                <input
                  [type]="showNewPassword ? 'text' : 'password'"
                  class="form-control"
                  [class.is-invalid]="hasError('newPassword')"
                  formControlName="newPassword"
                  placeholder="輸入新密碼"
                  autocomplete="new-password">
                <span class="input-group-text">
                  <a
                    href="javascript:void(0)"
                    class="link-secondary"
                    (click)="toggleNewPasswordVisibility()"
                    title="顯示密碼">
                    @if (!showNewPassword) {
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                        <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
                      </svg>
                    } @else {
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10.585 10.587a2 2 0 0 0 2.829 2.828" />
                        <path d="M16.681 16.673a8.717 8.717 0 0 1 -4.681 1.327c-3.6 0 -6.6 -2 -9 -6c1.272 -2.12 2.712 -3.678 4.32 -4.674m2.86 -1.146a9.055 9.055 0 0 1 1.82 -.18c3.6 0 6.6 2 9 6c-.666 1.11 -1.379 2.067 -2.138 2.87" />
                        <path d="M3 3l18 18" />
                      </svg>
                    }
                  </a>
                </span>
              </div>

              <!-- 密碼強度指示器 -->
              @if (resetForm.get('newPassword')?.value) {
                <div class="mt-2">
                  <div class="d-flex align-items-center">
                    <small class="text-muted me-2">密碼強度:</small>
                    <div class="progress flex-fill" style="height: 4px;">
                      <div
                        class="progress-bar"
                        [class.bg-danger]="getPasswordStrengthClass() === 'weak'"
                        [class.bg-warning]="getPasswordStrengthClass() === 'medium'"
                        [class.bg-success]="getPasswordStrengthClass() === 'strong'"
                        [style.width.%]="getPasswordStrengthClass() === 'weak' ? 33 : getPasswordStrengthClass() === 'medium' ? 66 : 100">
                      </div>
                    </div>
                    <small
                      class="ms-2"
                      [class.text-danger]="getPasswordStrengthClass() === 'weak'"
                      [class.text-warning]="getPasswordStrengthClass() === 'medium'"
                      [class.text-success]="getPasswordStrengthClass() === 'strong'">
                      {{ getPasswordStrengthText() }}
                    </small>
                  </div>
                </div>
              }

              <div class="invalid-feedback" [style.display]="hasError('newPassword') ? 'block' : 'none'">
                @if (hasError('newPassword', 'required')) {
                  <span>請輸入新密碼</span>
                }
                @if (hasError('newPassword', 'minlength')) {
                  <span>密碼長度至少需要 6 個字元</span>
                }
                @if (hasError('newPassword', 'maxlength')) {
                  <span>密碼長度不可超過 50 個字元</span>
                }
              </div>
            </div>

            <!-- 確認密碼欄位 -->
            <div class="mb-3">
              <label class="form-label required">確認新密碼</label>
              <div class="input-group input-group-flat">
                <input
                  [type]="showConfirmPassword ? 'text' : 'password'"
                  class="form-control"
                  [class.is-invalid]="hasError('confirmPassword') || hasFormError('passwordMismatch')"
                  formControlName="confirmPassword"
                  placeholder="再次輸入新密碼"
                  autocomplete="new-password">
                <span class="input-group-text">
                  <a
                    href="javascript:void(0)"
                    class="link-secondary"
                    (click)="toggleConfirmPasswordVisibility()"
                    title="顯示密碼">
                    @if (!showConfirmPassword) {
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                        <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
                      </svg>
                    } @else {
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10.585 10.587a2 2 0 0 0 2.829 2.828" />
                        <path d="M16.681 16.673a8.717 8.717 0 0 1 -4.681 1.327c-3.6 0 -6.6 -2 -9 -6c1.272 -2.12 2.712 -3.678 4.32 -4.674m2.86 -1.146a9.055 9.055 0 0 1 1.82 -.18c3.6 0 6.6 2 9 6c-.666 1.11 -1.379 2.067 -2.138 2.87" />
                        <path d="M3 3l18 18" />
                      </svg>
                    }
                  </a>
                </span>
              </div>
              <div class="invalid-feedback" [style.display]="hasError('confirmPassword') || hasFormError('passwordMismatch') ? 'block' : 'none'">
                @if (hasError('confirmPassword', 'required')) {
                  <span>請確認新密碼</span>
                }
                @if (hasFormError('passwordMismatch')) {
                  <span>兩次輸入的密碼不一致</span>
                }
              </div>
            </div>

            <!-- 提交按鈕 -->
            <div class="form-footer">
              <button
                type="submit"
                class="btn btn-primary w-100"
                [disabled]="isSubmitting">
                @if (isSubmitting) {
                  <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                  <span>重設中...</span>
                } @else {
                  <span>重設密碼</span>
                }
              </button>
            </div>
          </form>
        }
      </div>
    </div>

    <!-- 返回登入連結 -->
    <div class="text-center text-muted mt-3">
      記起密碼了？
      <a routerLink="/login" class="link-primary" tabindex="-1">返回登入</a>
    </div>
  </div>
</div>
