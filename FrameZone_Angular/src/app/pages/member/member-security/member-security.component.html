<div class="security-container">
  <!-- é é¢æ¨™é¡Œ -->
  <div class="page-header">
    <h2>å¸³è™Ÿå®‰å…¨</h2>
    <p>ç®¡ç†æ‚¨çš„å¯†ç¢¼ã€ç™»å…¥è£ç½®å’Œå¸³è™Ÿå®‰å…¨è¨­å®š</p>
  </div>

  <!-- æˆåŠŸè¨Šæ¯ -->
  @if (successMessage) {
    <div class="alert alert-success">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
      {{ successMessage }}
      <button class="alert-close" (click)="successMessage = ''">Ã—</button>
    </div>
  }

  <!-- éŒ¯èª¤è¨Šæ¯ -->
  @if (errorMessage) {
    <div class="alert alert-error">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      {{ errorMessage }}
      <button class="alert-close" (click)="errorMessage = ''">Ã—</button>
    </div>
  }

  <!-- ==================== è®Šæ›´å¯†ç¢¼ ==================== -->
  <div class="section">
    <h3 class="section-title">è®Šæ›´å¯†ç¢¼</h3>

    <div class="password-card">
      <form (ngSubmit)="changePassword()">
        <div class="form-group">
          <label class="form-label">ç›®å‰å¯†ç¢¼</label>
          <input
            type="password"
            class="form-control"
            [(ngModel)]="changePasswordForm.currentPassword"
            name="currentPassword"
            placeholder="è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼"
            [disabled]="isChangingPassword"
          />
        </div>

        <div class="form-group">
          <label class="form-label">æ–°å¯†ç¢¼</label>
          <input
            type="password"
            class="form-control"
            [(ngModel)]="changePasswordForm.newPassword"
            name="newPassword"
            placeholder="è‡³å°‘ 8 å€‹å­—å…ƒï¼ŒåŒ…å«å¤§å°å¯«å­—æ¯ã€æ•¸å­—åŠç‰¹æ®Šå­—å…ƒ"
            [disabled]="isChangingPassword"
            (input)="checkPasswordStrength()"
          />
          @if (changePasswordForm.newPassword && passwordStrength.score > 0) {
            <div class="password-strength">
              <div class="strength-bar">
                <div
                  class="strength-fill"
                  [style.width.%]="(passwordStrength.score / 6) * 100"
                  [style.background-color]="passwordStrength.color"
                ></div>
              </div>
              <span class="strength-text" [style.color]="passwordStrength.color">
                å¯†ç¢¼å¼·åº¦ï¼š{{ passwordStrength.text }}
              </span>
            </div>
          }
        </div>

        <div class="form-group">
          <label class="form-label">ç¢ºèªæ–°å¯†ç¢¼</label>
          <input
            type="password"
            class="form-control"
            [(ngModel)]="changePasswordForm.confirmPassword"
            name="confirmPassword"
            placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼"
            [disabled]="isChangingPassword"
          />
        </div>

        @if (passwordErrorMessage) {
          <div class="error-message">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            {{ passwordErrorMessage }}
          </div>
        }

        <div class="form-actions">
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="isChangingPassword"
          >
            @if (isChangingPassword) {
              <span class="spinner"></span>
              è®Šæ›´ä¸­...
            } @else {
              è®Šæ›´å¯†ç¢¼
            }
          </button>
        </div>
      </form>

      <div class="password-tips">
        <h4>å¯†ç¢¼å®‰å…¨å»ºè­°ï¼š</h4>
        <ul>
          <li>è‡³å°‘ 8 å€‹å­—å…ƒ</li>
          <li>åŒ…å«å¤§å¯«å­—æ¯ (A-Z)</li>
          <li>åŒ…å«å°å¯«å­—æ¯ (a-z)</li>
          <li>åŒ…å«æ•¸å­— (0-9)</li>
          <li>åŒ…å«ç‰¹æ®Šå­—å…ƒ (!&#64;#$%^&*)</li>
          <li>é¿å…ä½¿ç”¨å€‹äººè³‡è¨Šæˆ–å¸¸è¦‹å¯†ç¢¼</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- ==================== ç™»å…¥è£ç½®ç®¡ç† ==================== -->
  <div class="section">
    <div class="section-header">
      <h3 class="section-title">ç™»å…¥è£ç½®ç®¡ç†</h3>
      @if (sessions.length > 1) {
        <button class="btn btn-danger-outline" (click)="logoutOtherSessions()">
          ç™»å‡ºæ‰€æœ‰å…¶ä»–è£ç½®
        </button>
      }
    </div>

    <!-- è¼‰å…¥ä¸­ -->
    @if (isLoadingSessions) {
      <div class="loading-card">
        <div class="spinner"></div>
        <p>è¼‰å…¥ä¸­...</p>
      </div>
    }

    <!-- éŒ¯èª¤è¨Šæ¯ -->
    @if (!isLoadingSessions && sessionsErrorMessage) {
      <div class="error-card">
        <div class="error-icon">âš ï¸</div>
        <p>{{ sessionsErrorMessage }}</p>
        <button class="btn btn-retry" (click)="loadSessions()">é‡è©¦</button>
      </div>
    }

    <!-- ç©ºç‹€æ…‹ -->
    @if (!isLoadingSessions && !sessionsErrorMessage && sessions.length === 0) {
      <div class="empty-card">
        <div class="empty-icon">ğŸ’»</div>
        <p>æš«ç„¡ç™»å…¥è£ç½®</p>
      </div>
    }

    <!-- è£ç½®åˆ—è¡¨ -->
    @if (!isLoadingSessions && !sessionsErrorMessage && sessions.length > 0) {
      <div class="devices-list">
        @for (session of sessions; track session.sessionId) {
          <div class="device-card" [class.current-device]="session.isCurrentSession">
            <div class="device-icon">{{ getDeviceIcon(session.deviceType) }}</div>
            <div class="device-content">
              <div class="device-header">
                <span class="device-name">
                  {{ session.browserName }} ({{ session.operatingSystem }})
                </span>
                @if (session.isCurrentSession) {
                  <span class="current-badge">ç›®å‰è£ç½®</span>
                }
              </div>
              <div class="device-details">
                <div class="device-detail-item">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                  </svg>
                  <span>{{ session.ipAddress || 'æœªçŸ¥' }}</span>
                </div>
                <div class="device-detail-item">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  <span>{{ formatRelativeTime(session.lastActivityAt) }}</span>
                </div>
              </div>
            </div>
            @if (!session.isCurrentSession) {
              <button
                class="btn-logout-device"
                (click)="logoutSession(session.sessionId)"
                title="ç™»å‡ºæ­¤è£ç½®"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                  <polyline points="16 17 21 12 16 7"></polyline>
                  <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
              </button>
            }
          </div>
        }
      </div>
    }
  </div>

  <!-- ==================== å¸³è™Ÿé–å®šç‹€æ…‹ ==================== -->
  <div class="section">
    <h3 class="section-title">å¸³è™Ÿç‹€æ…‹</h3>

    <!-- è¼‰å…¥ä¸­ -->
    @if (isLoadingLockStatus) {
      <div class="loading-card">
        <div class="spinner"></div>
        <p>è¼‰å…¥ä¸­...</p>
      </div>
    }

    <!-- éŒ¯èª¤è¨Šæ¯ -->
    @if (!isLoadingLockStatus && lockStatusErrorMessage) {
      <div class="error-card">
        <div class="error-icon">âš ï¸</div>
        <p>{{ lockStatusErrorMessage }}</p>
        <button class="btn btn-retry" (click)="loadLockStatus()">é‡è©¦</button>
      </div>
    }

    <!-- å¸³è™Ÿç‹€æ…‹å¡ç‰‡ -->
    @if (!isLoadingLockStatus && !lockStatusErrorMessage && lockStatus) {
      <div class="lock-status-card" [class.locked]="lockStatus.isLocked">
        @if (lockStatus.isLocked) {
          <div class="status-icon locked">ğŸ”’</div>
          <div class="status-content">
            <h4 class="status-title">å¸³è™Ÿå·²é–å®š</h4>
            <p class="status-description">
              ç”±æ–¼ç™»å…¥å¤±æ•—æ¬¡æ•¸éå¤šï¼Œæ‚¨çš„å¸³è™Ÿå·²è¢«é–å®š
            </p>
            @if (lockStatus.remainingLockMinutes && lockStatus.remainingLockMinutes > 0) {
              <div class="lock-info">
                <div class="lock-info-item">
                  <span class="lock-label">å‰©é¤˜é–å®šæ™‚é–“ï¼š</span>
                  <span class="lock-value">{{ lockStatus.remainingLockMinutes }} åˆ†é˜</span>
                </div>
              </div>
            }
            @if (lockStatus.lockedReason) {
              <div class="lock-info">
                <div class="lock-info-item">
                  <span class="lock-label">é–å®šåŸå› ï¼š</span>
                  <span class="lock-value">{{ lockStatus.lockedReason }}</span>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="status-icon unlocked">âœ…</div>
          <div class="status-content">
            <h4 class="status-title">å¸³è™Ÿæ­£å¸¸</h4>
            <p class="status-description">æ‚¨çš„å¸³è™Ÿç›®å‰è™•æ–¼æ­£å¸¸ç‹€æ…‹</p>
            @if (lockStatus.failedLoginAttempts > 0) {
              <div class="lock-info">
                <div class="lock-info-item">
                  <span class="lock-label">ç™»å…¥å¤±æ•—æ¬¡æ•¸ï¼š</span>
                  <span class="lock-value">{{ lockStatus.failedLoginAttempts }} / 5</span>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </div>

  <!-- ==================== æœ€è¿‘ç™»å…¥è¨˜éŒ„ ==================== -->
  <div class="section">
    <div class="section-header">
      <h3 class="section-title">æœ€è¿‘ç™»å…¥è¨˜éŒ„</h3>
      <a routerLink="/member/logs" class="view-all-link">
        æŸ¥çœ‹å…¨éƒ¨
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M5 12h14"></path>
          <path d="M13 18l6 -6"></path>
          <path d="M13 6l6 6"></path>
        </svg>
      </a>
    </div>

    <!-- è¼‰å…¥ä¸­ -->
    @if (isLoadingRecentLogins) {
      <div class="loading-card">
        <div class="spinner"></div>
        <p>è¼‰å…¥ä¸­...</p>
      </div>
    }

    <!-- ç©ºç‹€æ…‹ -->
    @if (!isLoadingRecentLogins && recentLogins.length === 0) {
      <div class="empty-card">
        <div class="empty-icon">ğŸ“‹</div>
        <p>æš«ç„¡ç™»å…¥è¨˜éŒ„</p>
      </div>
    }

    <!-- ç™»å…¥è¨˜éŒ„åˆ—è¡¨ -->
    @if (!isLoadingRecentLogins && recentLogins.length > 0) {
      <div class="logins-list">
        @for (log of recentLogins; track log.logId) {
          <div class="login-item">
            <div class="login-icon">{{ getStatusIcon(log.status) }}</div>
            <div class="login-content">
              <div class="login-status">
                <span class="login-type">{{ log.status === 'Success' ? 'ç™»å…¥æˆåŠŸ' : 'ç™»å…¥å¤±æ•—' }}</span>
                <span class="login-time">{{ formatRelativeTime(log.createdAt) }}</span>
              </div>
              <div class="login-details">
                @if (log.ipAddress) {
                  <span class="login-detail">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="2" y1="12" x2="22" y2="12"></line>
                      <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    {{ log.ipAddress }}
                  </span>
                }
                @if (log.deviceType) {
                  <span class="login-detail">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                      <line x1="12" y1="18" x2="12.01" y2="18"></line>
                    </svg>
                    {{ log.deviceType }}
                  </span>
                }
              </div>
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>

<!-- ==================== å¯†ç¢¼è®Šæ›´æˆåŠŸæ¨¡æ…‹æ¡† ==================== -->
@if (showPasswordChangedModal) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-icon success">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <h3 class="modal-title">å¯†ç¢¼è®Šæ›´æˆåŠŸ</h3>
      <p class="modal-message">
        æ‚¨çš„å¯†ç¢¼å·²æˆåŠŸè®Šæ›´ã€‚<br>
        ç‚ºäº†å¸³æˆ¶å®‰å…¨ï¼Œç³»çµ±å°‡ç™»å‡ºæ‰€æœ‰è£ç½®ã€‚<br>
        è«‹ä½¿ç”¨æ–°å¯†ç¢¼é‡æ–°ç™»å…¥ã€‚
      </p>
      <div class="modal-countdown">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        {{ countdown }} ç§’å¾Œè‡ªå‹•è·³è½‰...
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary btn-full" (click)="logoutAndRedirect()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <polyline points="10 17 15 12 10 7"></polyline>
            <line x1="15" y1="12" x2="3" y2="12"></line>
          </svg>
          ç«‹å³å‰å¾€ç™»å…¥
        </button>
      </div>
    </div>
  </div>
}
