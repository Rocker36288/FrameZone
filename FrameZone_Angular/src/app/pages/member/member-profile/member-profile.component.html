<!-- 載入錯誤 -->
<div *ngIf="loadError" class="alert alert-danger" role="alert">
  <i class="bi bi-exclamation-triangle-fill me-2"></i>
  {{ loadError }}
  <button class="btn btn-sm btn-outline-danger ms-3" (click)="loadProfile()">
    <i class="bi bi-arrow-clockwise me-1"></i>
    重試
  </button>
</div>

<!-- 個人資料編輯表單 -->
<div *ngIf="!loadError" class="member-profile-container">

  <!-- 頁面標題 -->
  <div class="page-header mb-4">
    <h2 class="mb-1">✨ 個人資料</h2>
    <p class="text-muted">打造專屬於你的個人檔案</p>
  </div>

  <!-- 成功訊息 -->
  <div *ngIf="saveSuccess" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle-fill me-2"></i>
    <strong>太棒了！</strong> {{ saveSuccess }}
    <button type="button" class="btn-close" (click)="saveSuccess = null" aria-label="關閉">
      <i class="bi bi-x"></i>
    </button>
  </div>

  <!-- 錯誤訊息 -->
  <div *ngIf="saveError" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <strong>發生錯誤</strong>
    <pre class="mb-0">{{ saveError }}</pre>
    <button type="button" class="btn-close" (click)="saveError = null" aria-label="關閉">
      <i class="bi bi-x"></i>
    </button>
  </div>

  <form (ngSubmit)="onSubmit()" #profileForm="ngForm">

    <!-- 封面圖片區塊 -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-image"></i>
          封面照片
        </h5>
      </div>
      <div class="card-body">
        <div class="cover-image-section">
          <!-- 封面圖片預覽 -->
          <div class="cover-image-preview" [class.has-image]="coverImagePreview || coverImageIsHeic">
            <!-- 一般圖片預覽 -->
            <img *ngIf="coverImagePreview && !coverImageIsHeic" [src]="coverImagePreview" alt="封面照片">

            <!-- HEIC 格式佔位符 -->
            <div *ngIf="coverImageIsHeic" class="heic-placeholder">
              <i class="bi bi-file-earmark-image" style="font-size: 5rem; color: #667eea;"></i>
              <p class="mt-3 mb-2"><strong>{{ coverImageFileName }}</strong></p>
              <p class="text-muted mb-1">HEIC 格式已選擇</p>
              <p class="text-muted" style="font-size: 0.9rem;">您的瀏覽器無法預覽此格式</p>
              <p class="text-muted" style="font-size: 0.9rem;">儲存後將由後端處理並顯示</p>
            </div>

            <!-- 無圖片時的佔位符 -->
            <div *ngIf="!coverImagePreview && !coverImageIsHeic" class="placeholder">
              <i class="bi bi-image-fill"></i>
              <p><strong>建議尺寸</strong></p>
              <p>{{ imageLimits.COVER_IMAGE_RECOMMENDED_WIDTH }} x {{ imageLimits.COVER_IMAGE_RECOMMENDED_HEIGHT }} 像素</p>
            </div>
          </div>

          <!-- 封面圖片操作按鈕 -->
          <div class="cover-image-actions">
            <input type="file"
                   #coverImageInput
                   accept="image/*,.heic,.heif"
                   (change)="onCoverImageFileSelected($event)"
                   style="display: none;">
            <button type="button"
                    class="btn btn-outline-primary"
                    (click)="coverImageInput.click()">
              <i class="bi bi-cloud-upload me-1"></i>
              {{ (coverImagePreview || coverImageIsHeic) ? '更換封面照片' : '上傳封面照片' }}
            </button>
            <button type="button"
                    *ngIf="coverImagePreview || coverImageIsHeic"
                    class="btn btn-outline-danger"
                    (click)="removeCoverImage()">
              <i class="bi bi-trash me-1"></i>
              移除封面照片
            </button>
            <small class="text-muted d-block mt-2">
              <i class="bi bi-info-circle me-1"></i>
              支援格式: JPG, PNG, GIF, WebP, HEIC | 檔案大小上限: {{ imageLimits.COVER_IMAGE_MAX_SIZE_MB }}MB
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- 頭像區塊 -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-person-circle"></i>
          個人頭像
        </h5>
      </div>
      <div class="card-body">
        <div class="avatar-section">
          <!-- 頭像預覽 -->
          <div class="avatar-preview" [class.has-image]="avatarPreview || avatarIsHeic">
            <!-- 一般圖片預覽 -->
            <img *ngIf="avatarPreview && !avatarIsHeic" [src]="avatarPreview" alt="頭像">

            <!-- HEIC 格式佔位符 -->
            <div *ngIf="avatarIsHeic" class="heic-placeholder" style="text-align: center; padding: 2rem;">
              <i class="bi bi-file-earmark-image" style="font-size: 4rem; color: #667eea;"></i>
              <p class="mt-2 mb-1" style="font-size: 0.9rem;"><strong>{{ avatarFileName }}</strong></p>
              <p class="text-muted mb-0" style="font-size: 0.8rem;">HEIC 已選擇</p>
              <p class="text-muted" style="font-size: 0.75rem;">儲存後顯示</p>
            </div>

            <!-- 無圖片時的佔位符 -->
            <div *ngIf="!avatarPreview && !avatarIsHeic" class="placeholder">
              <i class="bi bi-person-circle"></i>
            </div>
          </div>

          <!-- 頭像操作 -->
          <div class="avatar-actions">
            <div>
              <input type="file"
                     #avatarInput
                     accept="image/*,.heic,.heif"
                     (change)="onAvatarFileSelected($event)"
                     style="display: none;">
              <button type="button"
                      class="btn btn-outline-primary"
                      (click)="avatarInput.click()">
                <i class="bi bi-cloud-upload me-1"></i>
                {{ (avatarPreview || avatarIsHeic) ? '更換頭像' : '上傳頭像' }}
              </button>
              <button type="button"
                      *ngIf="avatarPreview || avatarIsHeic"
                      class="btn btn-outline-danger"
                      (click)="removeAvatar()">
                <i class="bi bi-trash me-1"></i>
                移除頭像
              </button>
            </div>
            <small class="text-muted d-block">
              <i class="bi bi-info-circle me-1"></i>
              建議尺寸: {{ imageLimits.AVATAR_RECOMMENDED_WIDTH }} x {{ imageLimits.AVATAR_RECOMMENDED_HEIGHT }} 像素 |
              支援格式: JPG, PNG, GIF, WebP, HEIC |
              檔案大小上限: {{ imageLimits.AVATAR_MAX_SIZE_MB }}MB
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- 基本資料 -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-person-lines-fill"></i>
          基本資料
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <!-- Email (唯讀) -->
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-envelope-fill" style="margin-right: 0.25rem; color: #667eea;"></i>
              Email
            </label>
            <input type="email"
                   class="form-control"
                   [value]="profile?.email"
                   readonly>
            <small class="text-muted">
              <i class="bi bi-lock-fill me-1"></i>
              Email 無法修改
            </small>
          </div>

          <!-- 暱稱 -->
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-person-badge-fill" style="margin-right: 0.25rem; color: #667eea;"></i>
              暱稱
            </label>
            <input type="text"
                   class="form-control"
                   [(ngModel)]="formData.displayName"
                   name="displayName"
                   [maxlength]="fieldLimits.DISPLAY_NAME_MAX_LENGTH"
                   placeholder="請輸入暱稱">
            <small class="text-muted">
              <i class="bi bi-pencil-fill me-1"></i>
              還可輸入 {{ getRemainingCharacters(formData.displayName, fieldLimits.DISPLAY_NAME_MAX_LENGTH) }} 個字元
            </small>
          </div>

          <!-- 電話 -->
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-telephone-fill" style="margin-right: 0.25rem; color: #667eea;"></i>
              電話
            </label>
            <input type="tel"
                   class="form-control"
                   [(ngModel)]="formData.phone"
                   name="phone"
                   [maxlength]="fieldLimits.PHONE_MAX_LENGTH"
                   placeholder="請輸入電話號碼">
          </div>

          <!-- 所在地 -->
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-geo-alt-fill" style="margin-right: 0.25rem; color: #667eea;"></i>
              所在地
            </label>
            <input type="text"
                   class="form-control"
                   [(ngModel)]="formData.location"
                   name="location"
                   [maxlength]="fieldLimits.LOCATION_MAX_LENGTH"
                   placeholder="請輸入所在地">
          </div>

          <!-- 個人網站 -->
          <div class="col-12">
            <label class="form-label">
              <i class="bi bi-globe2" style="margin-right: 0.25rem; color: #667eea;"></i>
              個人網站
            </label>
            <input type="url"
                   class="form-control"
                   [(ngModel)]="formData.website"
                   name="website"
                   [maxlength]="fieldLimits.WEBSITE_MAX_LENGTH"
                   placeholder="https://your-website.com">
          </div>

          <!-- 個人簡介 -->
          <div class="col-12">
            <label class="form-label">
              <i class="bi bi-chat-text-fill" style="margin-right: 0.25rem; color: #667eea;"></i>
              個人簡介
            </label>
            <textarea class="form-control"
                      [(ngModel)]="formData.bio"
                      name="bio"
                      rows="4"
                      [maxlength]="fieldLimits.BIO_MAX_LENGTH"
                      placeholder="介紹一下您自己...分享您的興趣、專長或任何想讓大家知道的事"></textarea>
            <small class="text-muted">
              <i class="bi bi-pencil-fill me-1"></i>
              還可輸入 {{ getRemainingCharacters(formData.bio, fieldLimits.BIO_MAX_LENGTH) }} 個字元
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- 私密資料 -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-shield-lock-fill"></i>
          私密資料
        </h5>
        <small class="text-muted d-block mt-1">
          <i class="bi bi-info-circle me-1"></i>
          這些資訊不會公開顯示，僅供系統使用
        </small>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <!-- 真實姓名 -->
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-person-vcard-fill" style="margin-right: 0.25rem; color: #667eea;"></i>
              真實姓名
            </label>
            <input type="text"
                   class="form-control"
                   [(ngModel)]="formData.realName"
                   name="realName"
                   [maxlength]="fieldLimits.REAL_NAME_MAX_LENGTH"
                   placeholder="請輸入真實姓名">
          </div>

          <!-- 性別 -->
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-gender-ambiguous" style="margin-right: 0.25rem; color: #667eea;"></i>
              性別
            </label>
            <select class="form-select"
                    [(ngModel)]="formData.gender"
                    name="gender">
              <option [value]="null">請選擇性別</option>
              <option *ngFor="let option of genderOptions"
                      [value]="option.value">
                {{ option.label }}
              </option>
            </select>
          </div>

          <!-- 生日 -->
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-calendar-heart-fill" style="margin-right: 0.25rem; color: #667eea;"></i>
              生日
            </label>
            <input type="date"
                   class="form-control"
                   [(ngModel)]="formData.birthDate"
                   name="birthDate">
          </div>

          <!-- 國家 -->
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-flag-fill" style="margin-right: 0.25rem; color: #667eea;"></i>
              國家
            </label>
            <input type="text"
                   class="form-control"
                   [(ngModel)]="formData.country"
                   name="country"
                   [maxlength]="fieldLimits.COUNTRY_MAX_LENGTH"
                   placeholder="請輸入國家">
          </div>

          <!-- 城市 -->
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-buildings-fill" style="margin-right: 0.25rem; color: #667eea;"></i>
              城市
            </label>
            <input type="text"
                   class="form-control"
                   [(ngModel)]="formData.city"
                   name="city"
                   [maxlength]="fieldLimits.CITY_MAX_LENGTH"
                   placeholder="請輸入城市">
          </div>

          <!-- 郵遞區號 -->
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-mailbox2" style="margin-right: 0.25rem; color: #667eea;"></i>
              郵遞區號
            </label>
            <input type="text"
                   class="form-control"
                   [(ngModel)]="formData.postalCode"
                   name="postalCode"
                   [maxlength]="fieldLimits.POSTAL_CODE_MAX_LENGTH"
                   placeholder="請輸入郵遞區號">
          </div>

          <!-- 完整地址 -->
          <div class="col-12">
            <label class="form-label">
              <i class="bi bi-house-fill" style="margin-right: 0.25rem; color: #667eea;"></i>
              完整地址
            </label>
            <input type="text"
                   class="form-control"
                   [(ngModel)]="formData.fullAddress"
                   name="fullAddress"
                   [maxlength]="fieldLimits.FULL_ADDRESS_MAX_LENGTH"
                   placeholder="請輸入完整地址">
          </div>
        </div>
      </div>
    </div>

    <!-- 表單操作按鈕 -->
    <div class="form-actions">
      <button type="button"
              class="btn btn-outline-secondary"
              (click)="onCancel()"
              [disabled]="isSaving">
        <i class="bi bi-x-circle me-1"></i>
        取消變更
      </button>
      <button type="submit"
              class="btn btn-primary"
              [disabled]="isSaving">
        <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2"></span>
        <i *ngIf="!isSaving" class="bi bi-check-circle me-1"></i>
        {{ isSaving ? '儲存中...' : '儲存變更' }}
      </button>
    </div>

  </form>
</div>
