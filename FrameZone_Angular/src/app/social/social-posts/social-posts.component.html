@if(post){
<div class="card mb-3" id="">
  <div class="card-body">
    <!-- 功能選單（右上角） -->
    @if(post.isOwner){
    <div class="position-absolute top-0 end-0 m-2">
      <div class="dropdown">
        <button class="btn btn-sm btn-light" type="button" (click)="toggleMenu(); $event.stopPropagation()">
          ...
        </button>
        <ul class="dropdown-menu dropdown-menu-end" [class.show]="isMenuOpen">
          <li>
            <button class="dropdown-item" type="button" (click)="startEdit();toggleMenu()">
              編輯
            </button>
          </li>
          <li>
            <button class="dropdown-item text-danger" type="button" (click)="deletePost();toggleMenu()">
              刪除
            </button>
          </li>
        </ul>
      </div>
    </div>
    }
    <!-- 頭貼 + UserId + 時間 -->
    <div class="d-flex align-items-center mb-2">

      <!-- 頭像可點 -->
      <a class="avatar-wrapper me-2 d-inline-flex text-decoration-none" [routerLink]="['/social/profile', post.userId]">
        <img [src]="getPostUserAvatar()" [alt]="post.userName" />
      </a>

      <!-- 文字可點 -->
      <a class="text-decoration-none text-reset" [routerLink]="['/social/profile', post.userId]">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <strong>{{ post.userName }}</strong>

          @if (post.isSharedPost) {
          <span class="badge bg-light text-secondary border">已分享</span>
          }
        </div>

        <span class="text-muted" style="font-size: 0.85rem;">
          更新時間: {{ post.updatedAt | date:'yyyy-MM-dd HH:mm' }}
        </span>
      </a>

    </div>

    <!-- 顯示貼文文字內容 -->
    @if(!isEditing){
    <div class="post-content">
      @if(post.postContent.length <= 10){ <span>{{ post.postContent }}</span>
        } @else {
        <span>{{ isFullContent ? post.postContent : (post.postContent | slice:0:10) + '...' }}</span>
        <button class="btn btn-link btn-sm p-0 ms-1" (click)="toggleContent()">
          {{ isFullContent ? '' : '顯示全部' }}
        </button>
        }
    </div>
    }

    @if (post.postType === 'share') {
    <div class="shared-post border rounded p-2 mt-2 bg-light-subtle">
      @if (post.sharedPost) {

      <!-- ✅ 外層改成 div，不要整塊都是 link -->
      <div class="d-flex align-items-center mb-2">

        <!-- 頭像可點 -->
        <a class="avatar-wrapper me-2 d-inline-flex text-decoration-none"
          [routerLink]="['/social/profile', post.sharedPost.userId]">
          <img [src]="getSharedUserAvatar(post.sharedPost)" [alt]="post.sharedPost.userName" />
        </a>

        <!-- 文字可點 -->
        <a class="text-decoration-none text-reset" [routerLink]="['/social/profile', post.sharedPost.userId]">
          <div>
            <strong>{{ post.sharedPost.userName }}</strong><br />
            <span class="text-muted" style="font-size: 0.85rem;">
              更新時間: {{ post.sharedPost.updatedAt | date:'yyyy-MM-dd HH:mm' }}
            </span>
          </div>
        </a>

      </div>

      <div class="post-content">
        @if (post.sharedPost.postContent.length <= 10) { <span>{{ post.sharedPost.postContent }}</span>
          } @else {
          <span>
            {{ isFullContent ? post.sharedPost.postContent : (post.sharedPost.postContent | slice:0:10) + '...' }}
          </span>
          <button class="btn btn-link btn-sm p-0 ms-1" (click)="toggleContent()">
            {{ isFullContent ? '' : '顯示全部' }}
          </button>
          }
      </div>

      } @else {
      <p class="text-muted mb-0">原貼文已刪除</p>
      }
    </div>
    }


    <br>
    <hr class="my-2">

    <div class="row text-center">
      <div class="col-4">
        <button class="btn btn-ghost-dark w-100 py-2 d-flex align-items-center justify-content-center"
          (click)="toggleLikes()" [class.text-primary]="post.isLiked"> <i class="bi me-2"
            [class.bi-hand-thumbs-up]="!post.isLiked" [class.bi-hand-thumbs-up-fill]="post.isLiked"></i>
          {{ post.likeCount ?? 0 }} 讚
        </button>
      </div>
      <div class="col-4">
        <button class="btn btn-ghost-dark w-100 py-2 d-flex align-items-center justify-content-center"
          (click)="toggleComments()">
          <i class="bi bi-chat-square me-2"></i>{{ post.commentCount ?? 0 }} 則留言
        </button>
      </div>
      <div class="col-4">
        <button class="btn btn-ghost-dark w-100 py-2 d-flex align-items-center justify-content-center"
          (click)="openShareModal()" [class.text-primary]="post.isShared">
          <i class="bi bi-share me-2"></i>{{ post.shareCount ?? 0 }} 次分享
        </button>
      </div>
    </div>



    <!-- 編輯區 -->
    @if(isEditing){
    <div class="edit-container mt-2">
      <textarea class="form-control mb-2 edit-textarea" rows="5" [(ngModel)]="editContent"></textarea>

      <div class="d-flex justify-content-end gap-2">
        <button class="btn btn-success px-4" (click)="saveEdit()">保存</button>
        <button class="btn btn-secondary px-4" (click)="cancelEdit()">取消</button>
      </div>
    </div>
    }



    @if(isCommentShowed){
    <hr class="my-2">
    <!-- 顯示留言區 -->
    <div class="comment-section">
      <app-social-comments [comments]="comments()" [postId]="post.postId" (refresh)="refreshComments()">
      </app-social-comments>
    </div>


    <!-- 發布留言區 -->
    <div class="mt-3">
      <div class="d-flex align-items-center">
        <img [src]="getUserAvatar()" class="rounded-circle me-2" style="width:35px; height:35px; object-fit: cover;" />

        <div class="position-relative flex-grow-1">
          <input type="text" [(ngModel)]="newCommentContent" (keyup.enter)="sendComment()"
            class="form-control form-control-sm rounded-pill bg-light border-0 pe-5 comment-input-custom"
            placeholder="發佈留言...">

          <button (click)="sendComment()"
            class="btn position-absolute end-0 top-50 translate-middle-y p-0 me-3 btn-send-comment" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-send-2">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path
                d="M4.698 4.034l16.302 7.966l-16.302 7.966a.503 .503 0 0 1 -.546 -.124a.555 .555 0 0 1 -.12 -.568l2.468 -7.274l-2.468 -7.274a.555 .555 0 0 1 .12 -.568a.503 .503 0 0 1 .546 -.124z" />
              <path d="M6.5 12h14.5" />
            </svg>
          </button>
        </div>
      </div>
    </div>
    }
  </div>
</div>
}

@if (isShareModalOpen) {
<div class="modal-backdrop fade show"></div>
<div class="modal show d-block" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">分享貼文</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeShareModal()"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex flex-wrap gap-2 mb-3">
          <label class="share-option share-option--personal d-flex flex-column align-items-center gap-1 py-2 px-3"
            [class.share-option--selected]="shareTarget === 'personal'">
            <input class="visually-hidden" type="radio" name="shareTarget" value="personal" [(ngModel)]="shareTarget" />
            <i class="bi bi-person-circle fs-2"></i>
            <span>個人貼文</span>
          </label>
          <label class="share-option share-option--facebook d-flex flex-column align-items-center gap-1 py-2 px-3"
            [class.share-option--selected]="shareTarget === 'facebook'">
            <input class="visually-hidden" type="radio" name="shareTarget" value="facebook" [(ngModel)]="shareTarget" />
            <i class="bi bi-facebook fs-2"></i>
          </label>
          <label class="share-option share-option--twitter d-flex flex-column align-items-center gap-1 py-2 px-3"
            [class.share-option--selected]="shareTarget === 'twitter'">
            <input class="visually-hidden" type="radio" name="shareTarget" value="twitter" [(ngModel)]="shareTarget" />
            <i class="bi bi-twitter-x fs-2"></i>
          </label>
          <label class="share-option share-option--line d-flex flex-column align-items-center gap-1 py-2 px-3"
            [class.share-option--selected]="shareTarget === 'line'">
            <input class="visually-hidden" type="radio" name="shareTarget" value="line" [(ngModel)]="shareTarget" />
            <i class="bi bi-line fs-2"></i>
          </label>
        </div>
        <div class="mb-3">
          <label class="form-label">分享連結</label>
          <div class="input-group">
            <input class="form-control" [value]="shareLink" readonly />
            <button class="btn btn-outline-secondary" type="button" (click)="copyShareLink()">複製</button>
          </div>
        </div>
        @if (shareTarget === 'personal') {
        <div class="mb-3">
          <label class="form-label">分享訊息</label>
          <textarea class="form-control" rows="3" [(ngModel)]="shareMessage"></textarea>
        </div>
        }
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeShareModal()">取消</button>
        <button type="button" class="btn btn-primary" (click)="submitShare()">分享</button>
      </div>
    </div>
  </div>
</div>
}
