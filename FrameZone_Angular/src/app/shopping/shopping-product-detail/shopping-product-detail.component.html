<div class="product-detail-container">
  @if (currentProduct) {
  <div class="content-wrapper">

    <main class="product-main-info">

      <div class="product-left-column">

        <section class="product-images">
          <div class="main-image-box" (click)="toggleImageModal(true)">
            <div class="product-img-placeholder">
              <img [src]="currentImage" alt="商品主圖" class="main-product-image">
            </div>
          </div>

          <div class="image-meta-actions">
            <div class="thumbnails">

              <span class="nav-arrow left-arrow" (click)="scrollThumbnails('left')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler-chevron-left">
                  <path d="M15 6l-6 6l6 6" />
                </svg>
              </span>

              <div class="thumbnails-scroll-container" #thumbnailScrollContainer>
                <div *ngFor="let img of visibleImages" class="thumb" [class.active]="img === currentImage"
                  (click)="selectImage(img)">

                  <img [src]="img" alt="商品縮圖" class="thumbnail-image">

                </div>
              </div>

              <span class="nav-arrow right-arrow" (click)="scrollThumbnails('right')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler-chevron-right">
                  <path d="M9 6l6 6l-6 6" />
                </svg>
              </span>
            </div>

            <div class="side-actions">
              <!-- <button class="action-btn fav-btn" title="收藏" (click)="toggleFavorite()" [class.favorited]="isFavorite">

                <svg *ngIf="isFavorite" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                  fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" class="icon icon-tabler-heart-filled">
                  <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />
                </svg>

                <svg *ngIf="!isFavorite" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler-heart">
                  <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />
                </svg>
              </button> -->
              <app-favorite-button *ngIf="currentProduct" class="icon-border" [isFavorite]="currentProduct.isFavorite"
                [itemName]="currentProduct.name" [productId]="currentProduct.productId"
                (favoriteChange)="currentProduct.isFavorite = $event">
              </app-favorite-button>
            </div>
          </div>
        </section>

        <div class="seller-info-section product-section">
          <h2 class="seller-title">賣家資訊</h2>
          <div class="seller-detail-box">
            <div class="avatar-and-name">
              <div class="seller-avatar-placeholder">
                <img [src]="sellerInfo.avatar" class="reviewer-avatar" alt="賣家頭像">
              </div>
              <div class="seller-name-row">
                <div class="name-status">
                  <div class="seller-name">{{ sellerInfo.account }}</div>
                  <div class="seller-status">{{ sellerInfo.onlineStatus }}</div>
                </div>
                <div class="seller-rating-right" (click)="goToSellerReviews(sellerInfo.userId)">
                  <span class="star">★</span>
                  <span class="rating-val">{{ sellerInfo.rating || 0 }}</span>
                  <span class="review-count">({{ sellerInfo.reviewCount || 0 }}評價)</span>
                </div>
              </div>
            </div>
            <div class="seller-actions">
              <button class="seller-chat-btn" (click)="openSharedChat()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-message-chatbot">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M18 4a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-5l-5 3v-3h-2a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3h12z" />
                  <path d="M9.5 9h.01" />
                  <path d="M14.5 9h.01" />
                  <path d="M9.5 13a3.5 3.5 0 0 0 5 0" />
                </svg>
                聊聊
              </button>
              <button class="seller-store-btn" (click)="goToSellerShop(sellerInfo.userId)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-building-store">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M3 21l18 0" />
                  <path d="M3 7v1a3 3 0 0 0 6 0v-1m0 1a3 3 0 0 0 6 0v-1m0 1a3 3 0 0 0 6 0v-1h-18l2 -4h14l2 4" />
                  <path d="M5 21l0 -10.15" />
                  <path d="M19 21l0 -10.15" />
                  <path d="M9 21v-4a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v4" />
                </svg>
                查看賣場
              </button>
            </div>
          </div>
        </div>
      </div>

      <section class="product-options">
        <h1 class="product-title">{{ currentProduct?.name }}</h1>

        <div class="product-rating-summary" *ngIf="currentProduct?.reviewCount > 0">
          <div class="stars">
            <span *ngFor="let i of [1,2,3,4,5]" class="star" [class.filled]="i <= currentProduct.averageRating">★</span>
            <span class="rating-number">{{ currentProduct.averageRating | number:'1.1-1' }}</span>
          </div>
          <span class="divider">|</span>
          <span class="review-count">{{ currentProduct.reviewCount }} 個評價</span>
        </div>

        <div class="price-section">
          <span class="price">NT$ {{ currentProduct?.price }}</span>
        </div>

        @if (currentProduct?.specifications?.length > 1) {
        <div class="option-row">
          <label class="label">規格:</label>
          <div class="spec-chips">
            <button *ngFor="let spec of currentProduct.specifications" (click)="selectSpecification(spec)"
              [class.active]="selectedSpecification === spec" class="spec-chip">
              {{ spec.specName || '規格' }}
            </button>
          </div>
        </div>
        }

        <div class="option-row align-items-center">
          <label for="quantity-input" class="label">數量:</label>
          <div class="d-flex align-items-center gap-3">
            <input type="number" id="quantity-input" [(ngModel)]="quantity" min="1"
              [max]="selectedSpecification?.stockQuantity" class="quantity-input form-control w-auto" />

            <span class="stock-text text-secondary">
              庫存: {{ selectedSpecification?.stockQuantity ?? 0 }}
            </span>
          </div>
        </div>

        <div class="payment-method-info info-row">
          <label class="info-label">付款方式:</label>
          <div class="payment-list">
            <div *ngFor="let option of paymentOptions" class="payment-item">
              <span>{{ option.label }}</span>
            </div>
          </div>
        </div>

        <div class="shipping-discount-info">
          <div class="info-row shipping-row">
            <label class="info-label">運送:</label>
            <div class="shipping-list">
              <div *ngFor="let option of shippingOptions" class="shipping-item">
                <span>{{ option.label }} ${{ option.fee }}</span>
                <a *ngIf="option.isCombined" href="javascript:void(0)" class="combined-fee-link"
                  (click)="toggleShippingModal(true)">查看運費規則</a>
                <span *ngIf="option.note" class="shipping-note">{{ option.note }}</span>
              </div>
            </div>
          </div>

          <div class="info-row coupon-row">
            <label class="info-label">優惠券:</label>
            <div class="coupon-list">
              <button *ngFor="let coupon of availableCoupons" (click)="claimCoupon(coupon)"
                class="btn btn-sm coupon-btn" [class.btn-success]="coupon.isClaimed"
                [class.btn-outline-primary]="!coupon.isClaimed">
                {{ coupon.isClaimed ? '已領取' : '領取' }} (折{{ coupon.discount }})
              </button>
            </div>
          </div>
        </div>

        <div class="action-buttons-row justify-content-end">
          <button class="add-to-cart-btn btn btn-primary" (click)="addToCart()">
            加入購物車
          </button>
        </div>
      </section>
    </main>

    <section class="product-section product-description-section">
      <h2>商品描述</h2>
      <div class="content-box content-bordered-box">
        <p>{{ currentProduct?.description }}</p>
      </div>
    </section>

    <section class="product-section product-reviews-section">
      <h2>商品評價 ({{ currentProduct?.reviewCount || 0 }})</h2>
      <div class="content-box content-bordered-box">
        <div *ngIf="!currentProduct?.reviews || currentProduct.reviews.length === 0" class="no-reviews">
          目前尚無評價。
        </div>

        <div class="review-list" *ngIf="currentProduct?.reviews && currentProduct.reviews.length > 0">
          <div class="review-item" *ngFor="let review of currentProduct.reviews">
            <div class="review-header">
              <img [src]="review.reviewerAvatar" alt="評價者" class="reviewer-avatar">
              <div class="reviewer-info">
                <div class="reviewer-name">{{ review.reviewerName }}</div>
                <div class="review-rating">
                  <span *ngFor="let i of [1,2,3,4,5]" class="star" [class.filled]="i <= review.rating">★</span>
                </div>
                <div class="review-date">{{ review.createdAt | date:'yyyy-MM-dd HH:mm' }}</div>
              </div>
            </div>

            <div class="review-content">
              {{ review.content }}
            </div>

            <div class="review-photos" *ngIf="review.imageUrls && review.imageUrls.length > 0">
              <img *ngFor="let photo of review.imageUrls" [src]="photo" alt="評價圖片" class="review-photo"
                (click)="toggleImageModal(true, photo)">
            </div>

            <div class="seller-reply" *ngIf="review.reply">
              <div class="reply-title">賣家回覆:</div>
              <div class="reply-content">{{ review.reply }}</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="product-section similar-products-section">
      <h2>類似商品</h2>
      <div class="similar-list row similar-list-override">

        <div class="similar-col" *ngFor="let item of similarProducts">
          <app-product-card [product]="item" (favoriteChange)="item.isFavorite = $event"></app-product-card>

          <!-- <div class="card d-flex flex-column h-100 product-card-override">
            <a [routerLink]="['/shopping/product-detail', item.id]">
              <div class="card-img-top card-img-placeholder"><img [src]="item.img" [alt]="item.name"
                  class="product-thumb-image">
              </div>
            </a>
            <div class="card-body d-flex flex-column">
              <h3 class="card-title">
                <a [routerLink]="['/shopping/product-detail', item.id]">{{ item.name }}</a>
              </h3>
              <div class="text-secondary text-truncate mb-2 card-description-override">
                {{ item.desc }}
              </div>

              <div class="d-flex align-items-center pt-2 mt-auto">
                <div class="fw-bold price-color-override me-auto">NT$ {{ item.price }}</div>

                <div class="ms-auto"> -->
          <!-- <a href="javascript:void(0)" class="icon d-none d-md-inline-block ms-3 similar-fav-btn"
                    [class.favorited]="item.isFavorite" (click)="toggleSimilarFavorite(item)">

                    <svg *ngIf="item.isFavorite" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                      viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler-heart-filled">
                      <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />
                    </svg>

                    <svg *ngIf="!item.isFavorite" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                      viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                      stroke-linejoin="round" class="icon icon-tabler-heart">
                      <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />
                    </svg>
                  </a> -->
          <!-- <app-favorite-button [isFavorite]="item.isFavorite" [itemName]="product.name"
                    (favoriteChange)="item.isFavorite = $event">
                  </app-favorite-button> -->
        </div>
      </div>
    </section>

    <section class="product-section recommended-products-section similar-products-section">
      <h2>猜你喜歡</h2>
      <div class="similar-list row similar-list-override">
        <div class="similar-col" *ngFor="let item of recommendedProducts">
          <app-product-card [product]="item" (favoriteChange)="item.isFavorite = $event"></app-product-card>
        </div>
      </div>
    </section>
  </div>
  }
  @else {
  <div class="content-wrapper">
    <div class="container mt-5">
      <div class="text-center p-5 border rounded-3 bg-light">
        <div class="mb-3 text-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
            class="icon icon-tabler icon-tabler-search">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
            <path d="M21 21l-6 -6" />
          </svg>
          找不到商品
        </div>
        <p class="text-secondary mb-4">抱歉，您查詢的商品可能已下架、刪除或網址輸入錯誤。</p>

        <hr class="my-4">

        <button routerLink="/shopping/home" class="back-to-home btn d-inline-flex align-items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="icon icon-tabler icon-tabler-arrow-left">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M5 12l14 0" />
            <path d="M5 12l6 6" />
            <path d="M5 12l6 -6" />
          </svg>
          回到購物中心首頁
        </button>
      </div>
    </div>
  </div>
  }

  <div class="app-modal-overlay" *ngIf="showShippingModal">
    <div class="app-modal">
      <div class="modal-header">
        <span class="modal-title-content">
          <span class="modal-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-package">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M12 3l8 4.5l0 9l-8 4.5l-8 -4.5l0 -9l8 -4.5" />
              <path d="M12 12l8 -4.5" />
              <path d="M12 12l0 9" />
              <path d="M12 12l-8 -4.5" />
              <path d="M16 5.25l-8 4.5" />
            </svg>
          </span>
          <h3 class="modal-title">合併運費規則</h3>
        </span>
        <button class="close-btn modal-close-btn-override" (click)="toggleShippingModal(false)">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="icon icon-tabler icons-tabler-outline icon-tabler-x">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M18 6l-12 12" />
            <path d="M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p><strong>適用合併運費規則的項目：</strong></p>
        <ul class="shipping-modal-list">
          <li>郵寄/郵局包裹：2件以上一律固定運費 NT$ 80。</li>
          <li>7-11取貨/全家取貨：2件以上一律固定運費 NT$ 60。</li>
          <li>7-11取貨付款/全家取貨付款：2件以上一律固定運費 NT$ 70。</li>
        </ul>
        <p class="text-secondary mt-3">最終運費將以購物車結帳金額為準。您可以在結帳時查看詳細計算。</p>
      </div>
    </div>
  </div>

  <!-- <div class="chat-window" *ngIf="showChatWindow">
    <div class="chat-header">
      <span>{{ sellerInfo.account }}</span>
      <button class="close-btn" (click)="toggleChatWindow()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ffffff"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="icon icon-tabler icons-tabler-outline icon-tabler-x">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M18 6l-12 12" />
          <path d="M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="chat-body">
      <p class="system-message">您好！有什麼可以為您服務的嗎？</p>
    </div>
    <div class="chat-input-area">
      <div class="chat-function-row">
        <button class="chat-func-btn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="icon icon-tabler-plus">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M12 5l0 14" />
            <path d="M5 12l14 0" />
          </svg></button>
        <button class="chat-func-btn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="icon icon-tabler-mood-smile">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
            <path d="M9 10l.01 0" />
            <path d="M15 10l.01 0" />
            <path d="M9.5 15a3.5 3.5 0 0 0 5 0" />
          </svg></button>
      </div>
      <div class="chat-input">
        <input type="text" placeholder="請輸入訊息..." />
        <button class="send-btn">發送</button>
      </div>
    </div>
  </div> -->

  <!-- <div class="app-toast" *ngIf="showToast">
    {{ toastMessage }}
  </div> -->
</div>

<div class="app-image-modal-overlay" *ngIf="showImageModal" (click)="toggleImageModal(false)">
  <div class="app-image-modal" (click)="$event.stopPropagation()">

    <button class="modal-close-btn-override" (click)="toggleImageModal(false)">
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="icon icon-tabler-x">
        <path d="M18 6l-12 12" />
        <path d="M6 6l12 12" />
      </svg>
    </button>

    <img [src]="zoomImage" alt="放大圖片" class="image-modal-content">
  </div>
</div>

<!-- <div>
  <app-chat-window></app-chat-window>
</div> -->

<div>
  <app-toast-notification></app-toast-notification>
</div>

<div>
  <app-footer></app-footer>
</div>