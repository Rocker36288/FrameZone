<div class="page-header">
  <div class="top-navbar">
    <div class="top-nav-container d-flex justify-content-between align-items-center">
      <div class="d-flex top-nav-left">
        <a routerLink="/shopping/home" class="logo-link me-4">
          <img src="favicon5.png" alt="FrameZone Logo" class="brand-logo">
        </a>
      </div>
      <div class="d-flex top-nav-right">
        <a routerLink="/home" class="member-profile-link">
          <img [src]="memberAvatarUrl" alt="會員頭像" class="member-avatar">
          <span class="member-name">{{ memberName }}</span>
        </a>
      </div>
    </div>
  </div>
</div>

<div class="container py-4">
  <div class="checkout-stepper mb-5">
    <div class="step" [class.active]="currentStep >= 1">
      <div class="step-icon">1</div>
      <div class="step-label">購物車</div>
    </div>
    <div class="step-line" [class.active]="currentStep >= 2"></div>
    <div class="step" [class.active]="currentStep >= 2">
      <div class="step-icon">2</div>
      <div class="step-label">填寫資料</div>
    </div>
    <div class="step-line" [class.active]="currentStep >= 3"></div>
    <div class="step" [class.active]="currentStep >= 3">
      <div class="step-icon">3</div>
      <div class="step-label">完成訂單</div>
    </div>
  </div>
</div>

<div class="container">
  <div class="cart mb-4">
    <a routerLink="/shoppingcart" class="text-decoration-none text-secondary mb-3 d-inline-block">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-left"
        viewBox="0 0 16 16">
        <path fill-rule="evenodd"
          d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z" />
      </svg>
      返回購物車
    </a>
    <div class="card card-long">
      <div class="card-body">
        <p class="checkout-title fw-bold text-center">結帳</p>
      </div>
    </div>
  </div>

  <form [formGroup]="checkoutForm">
    <div class="row">
      <div class="col-lg-8">
        <div *ngFor="let group of groupedSelectedItems()" class="card mb-4 seller-group">
          <div class="card-header">
            <h3 class="card-title">
              <div class="d-flex align-items-center pt-1 mt-auto">
                <span class="avatar"
                  [style.background-image]="'url(' + (group.sellerAvatar || 'https://i.pravatar.cc/150?u=' + group.sellerId) + ')'"></span>
                <div class="ms-3">
                  <a [routerLink]="['/shopping/sellershop', group.sellerId]" class="text-body">{{ group.sellerName
                    }}</a>
                </div>
              </div>
            </h3>
          </div>
          <div class="card-body">
            <div *ngFor="let item of group.items" class="card mb-2 border-0 border-bottom pb-2">
              <div class="row align-items-center">
                <div class="col-3 col-md-2">
                  <img [src]="item.imageUrl || 'images/products/1.jpg'" class="img-fluid rounded" />
                </div>
                <div class="col-9 col-md-10">
                  <div class="fw-bold">{{item.name}}</div>
                  <div class="text-secondary">${{item.price}} x {{item.quantity}}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title">付款方式</h3>
          </div>
          <div class="card-body">
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" value="Credit" formControlName="paymentMethod"
                id="payCredit">
              <label class="form-check-label" for="payCredit">信用卡</label>
              <br>
              <input class="form-check-input" type="radio" value="ATM" formControlName="paymentMethod" id="payATM">
              <label class="form-check-label" for="payATM">ATM轉帳</label>
              <br>
              <input class="form-check-input" type="radio" value="COD" formControlName="paymentMethod"
                id="cash on delivery">
              <label class="form-check-label" for="cash on delivery">貨到付款</label>
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title">運送方式</h3>
          </div>
          <div class="card-body p-0">
            <!-- 郵寄：僅在非貨到付款時顯示 -->
            <div class="p-3" *ngIf="checkoutForm.get('paymentMethod')?.value !== 'COD'">
              <div class="form-check">
                <input class="form-check-input" type="radio" value="post" formControlName="shippingMethod" id="s1">
                <label class="form-check-label fw-bold" for="s1">郵寄</label>
              </div>
              <div class="mt-3 ms-4 px-3 border-start" *ngIf="checkoutForm.get('shippingMethod')?.value === 'post'">
                <p class="text-muted small mb-2">請選擇收件地址：</p>

                <!-- 已儲存的地址列表 -->
                <div *ngIf="savedAddresses.length > 0 && !useNewAddress">
                  <div *ngFor="let addr of savedAddresses" class="form-check mb-2">
                    <input class="form-check-input" type="radio" [value]="addr.id" formControlName="selectedAddressId"
                      [id]="'post'+addr.id">
                    <label class="form-check-label small" [for]="'post'+addr.id">
                      {{addr.name}} | {{addr.phone}} | {{addr.address}}
                    </label>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-primary mt-2" (click)="toggleNewAddress()">
                    使用新地址
                  </button>
                </div>

                <!-- 新地址輸入表單 -->
                <div *ngIf="useNewAddress" class="new-address-form">
                  <div class="mb-3">
                    <label class="form-label small">收件人姓名</label>
                    <input type="text" class="form-control form-control-sm" placeholder="請輸入收件人姓名"
                      [(ngModel)]="newRecipientName" [ngModelOptions]="{standalone: true}">
                  </div>
                  <div class="mb-3">
                    <label class="form-label small">電話號碼</label>
                    <input type="tel" class="form-control form-control-sm" placeholder="請輸入電話號碼"
                      [(ngModel)]="newPhoneNumber" [ngModelOptions]="{standalone: true}">
                  </div>
                  <div class="mb-3">
                    <label class="form-label small">完整地址</label>
                    <input type="text" class="form-control form-control-sm" placeholder="請輸入完整地址"
                      [(ngModel)]="newFullAddress" [ngModelOptions]="{standalone: true}">
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="saveAddress" [(ngModel)]="saveAddress"
                      [ngModelOptions]="{standalone: true}">
                    <label class="form-check-label small" for="saveAddress">
                      儲存此地址供下次使用
                    </label>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-primary" (click)="onCreateAddress()">
                      確認地址
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" (click)="toggleNewAddress()"
                      *ngIf="savedAddresses.length > 0">
                      取消
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- 7-11 取貨：非貨到付款 -->
            <div class="p-3" *ngIf="checkoutForm.get('paymentMethod')?.value !== 'COD'">
              <div class="form-check">
                <input class="form-check-input" type="radio" value="711" formControlName="shippingMethod" id="s2">
                <label class="form-check-label fw-bold" for="s2">7-11 取貨</label>
              </div>
              <div class="mt-3 ms-4 px-3 border-start" *ngIf="checkoutForm.get('shippingMethod')?.value === '711'">
                <p class="text-muted small mb-2">請選擇取貨門市：</p>
                <div *ngFor="let addr of pickupStores" class="form-check mb-2">
                  <input class="form-check-input" type="radio" [value]="addr.id" formControlName="selectedAddressId"
                    [id]="'s2'+addr.id">
                  <label class="form-check-label small" [for]="'s2'+addr.id">
                    {{addr.recipientName}} | {{addr.phone}} | {{addr.name}} | {{addr.address}}
                  </label>
                </div>
              </div>
            </div>

            <!-- 7-11 貨到付款：僅在貨到付款時顯示 -->
            <div class="p-3" *ngIf="checkoutForm.get('paymentMethod')?.value === 'COD'">
              <div class="form-check">
                <input class="form-check-input" type="radio" value="711_pay" formControlName="shippingMethod" id="s3">
                <label class="form-check-label fw-bold" for="s3">貨到付款</label>
              </div>
              <div class="mt-3 ms-4 px-3 border-start" *ngIf="checkoutForm.get('shippingMethod')?.value === '711_pay'">
                <p class="text-muted small mb-2">請選擇取貨門市：</p>
                <div *ngFor="let addr of pickupStores" class="form-check mb-2">
                  <input class="form-check-input" type="radio" [value]="addr.id" formControlName="selectedAddressId"
                    [id]="'s3'+addr.id">
                  <label class="form-check-label small" [for]="'s3'+addr.id">
                    {{addr.recipientName}} | {{addr.phone}} | {{addr.name}} | {{addr.address}}
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-4 sticky-top pt-4">
        <div class="subtotal">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="m-0">優惠券:</h2>
                <div class="text-danger fw-bold d-flex align-items-center">
                  {{ cartService.selectedCoupon()?.code }}
                  {{ getDiscountDisplay() }}
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-2 mt-4">
                <h2 class="m-0">小計:</h2>
                <h2 class="m-0 text-end">${{ getTotalAmount() }}</h2>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-2 mt-4">
                <h2 class="m-0">運費:</h2>
                <h2 class="m-0 text-end">${{ getShippingFee() }}</h2>
              </div>
              <hr>
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="m-0">應付總金額:</h2>
                <h2 class="m-0 text-end text-primary fw-bold">${{ getFinalTotal() }}</h2>
              </div>
              <button type="button" (click)="onConfirmCheckout()" [disabled]="checkoutForm.invalid"
                class="btn btn-animate-icon w-100 checkout-button text-white"
                [style.background-color]="checkoutForm.invalid ? '#cccccc' : '#764ba2'"
                [style.cursor]="checkoutForm.invalid ? 'not-allowed' : 'pointer'">
                {{ checkoutForm.invalid ? '請完整填寫資料' : '確認結帳 ' }}
                >
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<div class="modal fade" id="couponModal" tabindex="-1" #couponModalElement>
</div>

<!-- 隱藏表單已設置在後端 -->
<!-- <div>
  <app-ecpay-form *ngIf="ecpayParams" [apiUrl]="ecpayParams.serviceURL"
    [postData]="ecpayParams.params"></app-ecpay-form>
</div> -->