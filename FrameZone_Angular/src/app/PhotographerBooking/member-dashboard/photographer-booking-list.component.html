<header class="navbar navbar-expand-md d-print-none">
    <div class="container-xl">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu"
            aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
            <a routerLink="/home" aria-label="FrameZone" class="d-flex align-items-center gap-2 text-decoration-none">
                <div class="logo-image">
                    <img src="favicon2.png" alt="FrameZone Logo" width="32" height="32">
                </div>
                <h2 class="mb-0">FrameZone</h2>
            </a>
        </div>

        <div class="collapse navbar-collapse" id="navbar-menu">
            <ul class="navbar-nav ms-auto me-3">
                <li class="nav-item">
                    <a class="nav-link" routerLink="/photographer-bookinghome">
                        <span class="nav-link-icon d-md-none d-lg-inline-block">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round"
                                class="icon icon-tabler icons-tabler-outline icon-tabler-camera">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path
                                    d="M5 7h1l2 -2h8l2 2h1a3 3 0 0 1 3 3v9a3 3 0 0 1 -3 3h-14a3 3 0 0 1 -3 -3v-9a3 3 0 0 1 3 -3" />
                                <path d="M9 13a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
                            </svg>
                        </span>
                        <span class="nav-link-title">探索攝影師</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" routerLink="/home">
                        <span class="nav-link-icon d-md-none d-lg-inline-block">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-home">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path d="M5 12l-2 0l9 -9l9 9l-2 0" />
                                <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
                                <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
                            </svg>
                        </span>
                        <span class="nav-link-title">返回首頁</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</header>

<div class="full-page-wrapper">
    <div class="booking-list-container animate-fade-in">
        <div class="list-header">
            <h2>我的預約管理</h2>
            <p>在此查看您的拍攝進度與預約紀錄</p>
        </div>

        <div class="booking-grid">
            <div *ngFor="let booking of bookings" class="booking-card">
                <div class="card-top">
                    <span class="booking-nr">#{{ booking.bookingNumber }}</span>
                    <span [class]="'status-badge ' + getStatusClass(booking)">{{
                        getDisplayStatus(booking)
                        }}</span>
                </div>

                <div class="card-content">
                    <div class="main-info" (click)="toggleDetails(booking)" style="cursor: pointer">
                        <div class="d-flex justify-content-between align-items-start">
                            <h3 class="service-name">{{ booking.serviceName }}</h3>
                            <i class="ti" [ngClass]="
                  booking.isExpanded ? 'ti-chevron-up' : 'ti-chevron-down'
                " style="color: #64748b"></i>
                        </div>
                        <p class="photographer" [routerLink]="['/photographer-detail']"
                            [queryParams]="{ id: booking.photographerId }"
                            style="cursor: pointer; transition: color 0.2s;">
                            <i class="ti ti-camera"></i> {{ booking.photographerName }}
                            <small style="color: #64748b; margin-left: 4px;">(點擊查看專頁)</small>
                        </p>
                    </div>

                    <!-- 點擊後才展開的詳情區 -->
                    <div class="expandable-details" *ngIf="booking.isExpanded">
                        <div class="detail-info">
                            <div class="info-row">
                                <i class="ti ti-calendar"></i>
                                <span>{{
                                    (booking.bookingStartDatetime || booking.bookingDate) | date : "yyyy-MM-dd HH:mm"
                                    }}</span>
                            </div>
                            <div class="info-row">
                                <i class="ti ti-coin"></i>
                                <span class="price">TWD {{ (booking.servicePrice || booking.price) | number }}</span>
                            </div>
                        </div>

                        <div class="promises-footer">
                            <div class="promise-item">
                                <span class="label">精修</span>
                                <span class="value">{{ booking.includedPhotos }}</span>
                            </div>
                            <div class="promise-item">
                                <span class="label">交付</span>
                                <span class="value">{{ booking.deliveryDays }}天</span>
                            </div>
                            <div class="promise-item">
                                <span class="label">預估</span>
                                <span class="value">{{
                                    booking.expectedDeliveryDate | date : "MM/dd"
                                    }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-actions">
                    <button class="btn-detail" (click)="viewVoucher(booking)">
                        查看憑證
                    </button>

                    <button *ngIf="getDisplayStatus(booking) === '待付款'" class="btn-detail btn-pay"
                        (click)="onPay(booking)">
                        立即付款
                    </button>

                    <button *ngIf="booking.bookingStatus === '已完成' && !booking.isReviewed" class="btn-detail btn-review"
                        (click)="openReviewModal(booking)">
                        去評價
                    </button>

                    <button *ngIf="booking.isReviewed" class="btn-reviewed" disabled>
                        已評價
                    </button>

                    <button
                        *ngIf="booking.bookingStatus !== '已完成' && !booking.isReviewed && getDisplayStatus(booking) !== '待付款'"
                        class="btn-contact">
                        聯繫攝影師
                    </button>
                </div>
            </div>

            <div *ngIf="bookings.length === 0" class="empty-state">
                <i class="ti ti-calendar-x"></i>
                <p>目前尚無預約紀錄</p>
            </div>
        </div>
    </div>
</div>

<!-- 模擬評價彈窗 -->
<div class="review-modal-overlay" *ngIf="showReviewModal" (click)="closeReviewModal()">
    <div class="review-modal-box animate-fade-in" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>撰寫攝影服務評價</h3>
            <button class="close-btn" (click)="closeReviewModal()">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="target-info">
                <i class="ti ti-camera"></i>
                <span>正在為
                    <strong>{{ currentReviewBooking?.photographerName }}</strong>
                    進行評分</span>
            </div>

            <div class="rating-selector">
                <div class="stars">
                    <i *ngFor="let s of [1, 2, 3, 4, 5]" class="ti" [ngClass]="
              s <= tempRating ? 'ti-star-filled text-warning' : 'ti-star'
            " (click)="setRating(s)">
                    </i>
                </div>
                <div class="rating-text">
                    {{ tempRating }} 分 -
                    {{
                    tempRating >= 5
                    ? "極致完美"
                    : tempRating >= 4
                    ? "品質優異"
                    : tempRating >= 3
                    ? "符合期待"
                    : "尚可改善"
                    }}
                </div>
            </div>

            <div class="comment-area">
                <label>服務心得回饋</label>
                <textarea [(ngModel)]="tempComment" placeholder="分享拍攝過程中的閃光點，或是給攝影師的誠摯建議..."></textarea>
            </div>

            <div class="upload-simulation">
                <div class="upload-btn">
                    <i class="ti ti-photo-plus"></i>
                    <span>上傳拍攝作品</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" (click)="closeReviewModal()">稍後再說</button>
            <button class="btn-submit" (click)="submitReview()">正式提交評價</button>
        </div>
    </div>
</div>