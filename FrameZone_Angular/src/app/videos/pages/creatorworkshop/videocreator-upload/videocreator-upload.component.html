<div class="container py-5">

  <!-- 標題 -->
  <h2 class="mb-4 fw-bold">上傳影片</h2>

  <!-- 上傳區 (未上傳時顯示) -->
  <div class="card mb-4 border-2 border-dashed text-center upload-zone" *ngIf="!uploadFinished && !uploading"
    (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
    <div class="card-body py-5">
      <i class="ti ti-video-plus fs-1 text-primary mb-3"></i>
      <p class="fs-5 mb-2">拖放影片檔案到這裡，或</p>

      <button class="btn btn-primary mb-2" (click)="fileInput.click()">
        <i class="ti ti-upload me-1"></i> 選擇檔案
      </button>

      <input #fileInput type="file" class="d-none" accept="video/*" (change)="onFileSelected($event)">

      <div class="text-muted mt-3 small">
        支援格式:MP4、AVI、MOV(最大 500MB)
      </div>
    </div>
  </div>

  <!-- 上傳進度 -->
  <div class="card mb-4" *ngIf="uploading">
    <div class="card-body">
      <h5 class="mb-3">
        <i class="ti ti-upload me-2"></i>上傳中
      </h5>
      <div class="progress mb-2" style="height: 25px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
          [style.width.%]="uploadProgress" [attr.aria-valuenow]="uploadProgress" aria-valuemin="0" aria-valuemax="100">
          {{ uploadProgress }}%
        </div>
      </div>
      <div class="text-muted small">
        {{ statusMessage }}
      </div>
    </div>
  </div>

  <!-- 上傳失敗警示 -->
  <div class="alert alert-danger mb-4 d-flex align-items-center" *ngIf="!uploading && uploadFail" role="alert">
    <i class="ti ti-alert-circle me-2 fs-4"></i>
    <div>
      <strong>上傳失敗</strong><br>
      {{ statusMessage }}
    </div>
    <button class="btn btn-sm btn-outline-danger ms-auto" (click)="resetUploadState()">
      重新上傳
    </button>
  </div>

  <!-- 影片處理區域 (上傳完成後) -->
  <div *ngIf="uploadFinished">

    <div class="card mb-4">
      <div class="card-header fw-bold">
        <i class="ti ti-player-play me-2"></i>影片預覽
      </div>
      <div class="card-body p-0">
        <div class="video-wrapper">
          <ng-container *ngIf="isReady; else placeholder">
            <app-video-player [src]="videoplayuri"></app-video-player>
          </ng-container>

          <ng-template #placeholder>
            <div class="placeholder">
              <i class="ti ti-refresh me-2"></i>影片尚在轉碼中...
            </div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- 轉碼進度 -->
    <div class="card mb-4" *ngIf="isTranscoding">
      <div class="card-body">
        <h5 class="mb-3">
          <i class="ti ti-refresh me-2"></i>影片轉碼中
        </h5>
        <div class="progress mb-2" style="height: 25px;">
          <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar"
            [style.width.%]="transcodeProgress" [attr.aria-valuenow]="transcodeProgress" aria-valuemin="0"
            aria-valuemax="100">
            {{ transcodeProgress }}%
          </div>
        </div>
        <div class="text-muted small">
          正在處理影片,請稍候...
        </div>
      </div>
    </div>

    <!-- 縮圖選擇 -->
    <div class="card mb-4" *ngIf="canShowThumbnails">
      <div class="card-header fw-bold">
        <i class="ti ti-photo me-2"></i>選擇影片縮圖
      </div>
      <div class="card-body">
        <p class="text-muted mb-3">{{ statusMessage }}</p>

        <div class="thumbnails-grid row g-3 mb-4">
          <div class="col-6 col-md-4 col-lg-3" *ngFor="let thumb of thumbnails">
            <div class="thumbnail-item position-relative" [class.selected]="selectedThumbnail === thumb"
              (click)="selectThumbnail(thumb)" role="button" tabindex="0">
              <img [src]="thumb" alt="縮圖預覽" class="img-fluid rounded">
              <div class="thumbnail-overlay" *ngIf="selectedThumbnail === thumb">
                <i class="ti ti-check fs-2 text-white"></i>
              </div>
            </div>
          </div>

          <!-- 自訂縮圖上傳 -->
          <div class="mt-3">
            <label class="btn btn-outline-secondary">
              從電腦選擇縮圖
              <input type="file" accept="image/*" hidden (change)="onThumbnailFileSelected($event)" />
            </label>
          </div>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-primary" [disabled]="!selectedThumbnail" (click)="saveThumbnail()">
            <i claass="ti ti-check me-1"></i>確認使用此縮圖
          </button>
          <button class="btn btn-outline-secondary" (click)="loadThumbnails()">
            <i class="ti ti-refresh me-1"></i>重新載入
          </button>
        </div>
      </div>
    </div>

    <!-- 影片資訊表單 -->
    <div class="card" *ngIf="canShowVideoForm">
      <div class="card-header fw-bold">
        <i class="ti ti-edit me-2"></i>影片詳細資訊
      </div>

      <div class="card-body">
        <form>
          <!-- 標題 -->
          <div class="mb-4">
            <label class="form-label fw-semibold">
              影片標題 <span class="text-danger">*</span>
            </label>
            <input type="text" class="form-control" [(ngModel)]="videoTitle" name="videoTitle" maxlength="100"
              placeholder="輸入吸引人的標題" required>
            <div class="form-text">最多 100 個字元</div>
          </div>

          <!-- 描述 -->
          <div class="mb-4">
            <label class="form-label fw-semibold">影片描述</label>
            <textarea class="form-control" [(ngModel)]="videoDescription" name="videoDescription" rows="4"
              maxlength="5000" placeholder="描述您的影片內容..."></textarea>
            <div class="form-text">最多 5000 個字元</div>
          </div>

          <!-- 隱私設定 -->
          <div class="mb-4">
            <label class="form-label fw-semibold">
              隱私設定 <span class="text-danger">*</span>
            </label>
            <div class="row g-3">

              <div class="col-md-4">
                <input type="radio" name="privacy" [value]="PrivacyStatus.PUBLIC" [(ngModel)]="selectedPrivacy"
                  id="privacy-public" class="btn-check">
                <label class="card h-100 privacy-card" for="privacy-public">
                  <div class="card-body text-center">
                    <i class="ti ti-world fs-2 text-primary mb-2"></i>
                    <div class="fw-bold">公開</div>
                    <small class="text-muted">所有人都可以觀看</small>
                  </div>
                </label>
              </div>

              <div class="col-md-4">
                <input type="radio" name="privacy" [value]="PrivacyStatus.UNLISTED" [(ngModel)]="selectedPrivacy"
                  id="privacy-unlisted" class="btn-check">
                <label class="card h-100 privacy-card" for="privacy-unlisted">
                  <div class="card-body text-center">
                    <i class="ti ti-link fs-2 mb-2"></i>
                    <div class="fw-bold">不公開列出</div>
                    <small class="text-muted">有連結的人可觀看</small>
                  </div>
                </label>
              </div>

              <div class="col-md-4">
                <input type="radio" name="privacy" [value]="PrivacyStatus.PRIVATE" [(ngModel)]="selectedPrivacy"
                  id="privacy-private" class="btn-check">
                <label class="card h-100 privacy-card" for="privacy-private">
                  <div class="card-body text-center">
                    <i class="ti ti-lock fs-2 mb-2"></i>
                    <div class="fw-bold">私人</div>
                    <small class="text-muted">僅自己可觀看</small>
                  </div>
                </label>
              </div>

            </div>
          </div>

          <!-- 提交按鈕 -->
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-primary" [disabled]="!isReady || !videoTitle.trim()"
              (click)="publishVideo()">
              <i class="ti ti-check me-1"></i>發佈影片
            </button>
            <button type="button" class="btn btn-outline-secondary" [disabled]="!videoTitle.trim()"
              (click)="saveDraft()">
              <i class="ti ti-device-floppy me-1"></i>儲存草稿
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>