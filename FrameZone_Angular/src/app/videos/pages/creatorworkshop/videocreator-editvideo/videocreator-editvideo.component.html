<div class="page-wrapper">

  <!-- ===== Header ===== -->
  <div class="page-header">
    <div class="container-xl">
      <div class="row align-items-center">
        <div class="col">
          <div class="page-pretitle">影片管理</div>
          <h2 class="page-title">
            <i class="ti ti-video me-2"></i>影片詳情
          </h2>
        </div>

        <div class="col-auto ms-auto">
          <div class="btn-list">
            <button class="btn btn-danger" (click)="deleteVideo()">
              <i class="ti ti-trash me-1"></i>刪除
            </button>
            <a routerLink="/videos" class="btn btn-outline-secondary">
              <i class="ti ti-arrow-left me-1"></i>返回
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Body ===== -->
  <div class="page-body">
    <div class="container-xl">

      <!-- 影片修改警示 -->
      <div *ngIf="hasUnsavedChanges"
        class="alert alert-warning alert-important d-flex justify-content-between align-items-center mb-4">
        <div>
          <i class="ti ti-alert-circle me-2"></i>
          <strong>影片已修改，尚未儲存</strong>
        </div>
        <button class="btn btn-sm btn-primary" (click)="saveAllChanges()">
          <i class="ti ti-device-floppy me-1"></i>確認修改
        </button>
      </div>

      <!-- ===== 標題區塊 ===== -->
      <div class="card mb-4 shadow-sm">
        <div class="card-body py-4">
          <!-- 顯示模式 -->
          <div *ngIf="!editingTitle" class="d-flex align-items-center gap-3">
            <h2 class="mb-0 flex-grow-1">{{ video.title }}</h2>
            <button class="btn btn-ghost-secondary btn-icon" (click)="startEditTitle()" title="編輯標題">
              <i class="ti ti-edit"></i>
            </button>
          </div>

          <!-- 編輯模式 -->
          <div *ngIf="editingTitle">
            <input class="form-control form-control-lg mb-3" [(ngModel)]="editTitle" placeholder="輸入影片標題">
            <div class="d-flex gap-2">
              <button class="btn btn-primary" (click)="saveTitle()">
                <i class="ti ti-check me-1"></i>確認
              </button>
              <button class="btn btn-outline-secondary" (click)="cancelEditTitle()">
                <i class="ti ti-x me-1"></i>取消
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="row row-cards">

        <!-- ================= 左側：影片主內容 ================= -->
        <div class="col-lg-8">

          <!-- ===== 影片播放器 ===== -->
          <div class="card mb-4 shadow-sm">
            <div class="card-body p-0">
              <div *ngIf="video.videoUrl" class="ratio ratio-16x9">
                <video controls [poster]="video.thumbnailUrl" class="rounded-top">
                  <source [src]="video.videoUrl" type="video/mp4">
                </video>
              </div>

              <img *ngIf="!video.videoUrl && video.thumbnailUrl" [src]="video.thumbnailUrl" class="card-img-top">

              <div *ngIf="!video.videoUrl && !video.thumbnailUrl"
                class="ratio ratio-16x9 bg-light d-flex justify-content-center align-items-center">
                <div class="text-muted text-center p-4">
                  <i class="ti ti-video-off" style="font-size: 3rem;"></i>
                  <p class="mb-0 mt-3">無可用影片</p>
                </div>
              </div>
            </div>
          </div>

          <!-- ===== 統計數據卡片 ===== -->
          <div class="row row-cards mb-4">
            <div class="col-sm-4" *ngFor="let item of [
              { label:'觀看次數', value:viewCount, icon:'eye', color:'blue' },
              { label:'喜歡數', value:likeCount, icon:'heart', color:'red' },
              { label:'留言數', value:commentCount, icon:'message', color:'green' }
            ]">
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="subheader">{{ item.label }}</div>
                  </div>
                  <div class="d-flex align-items-baseline mt-2">
                    <div class="h2 mb-0 me-2">{{ item.value }}</div>
                    <div class="ms-auto">
                      <span class="badge bg-{{item.color}}-lt">
                        <i class="ti ti-{{item.icon}}"></i>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ===== 影片描述 ===== -->
          <div class="card shadow-sm">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title">
                  <i class="ti ti-align-left me-2"></i>影片說明
                </h3>
                <button *ngIf="!editingDescription" class="btn btn-ghost-secondary btn-icon btn-sm"
                  (click)="startEditDescription()" title="編輯說明">
                  <i class="ti ti-edit"></i>
                </button>
              </div>
            </div>

            <div class="card-body">
              <p *ngIf="!editingDescription" class="mb-0" style="white-space: pre-wrap;">
                {{ video.description || '未提供描述' }}
              </p>

              <div *ngIf="editingDescription">
                <textarea class="form-control mb-3" rows="6" [(ngModel)]="editDescription"
                  placeholder="輸入影片說明..."></textarea>
                <div class="d-flex gap-2">
                  <button class="btn btn-primary" (click)="saveDescription()">
                    <i class="ti ti-check me-1"></i>確認
                  </button>
                  <button class="btn btn-outline-secondary" (click)="cancelEditDescription()">
                    <i class="ti ti-x me-1"></i>取消
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- ================= 右側：管理資訊 ================= -->
        <div class="col-lg-4">

          <!-- ===== 影片狀態 ===== -->
          <div class="card mb-4 shadow-sm">
            <div class="card-header">
              <h3 class="card-title">
                <i class="ti ti-settings me-2"></i>影片管理
              </h3>
            </div>

            <div class="card-body">

              <!-- 縮圖預覽 -->
              <div class="mb-4">
                <label class="form-label">影片縮圖</label>
                <div class="position-relative thumbnail-container">
                  <img [src]="video.thumbnailUrl || '/assets/placeholder-thumbnail.jpg'"
                    class="img-fluid rounded w-100 thumbnail-preview" (click)="editThumbnail()">

                  <div class="thumbnail-overlay rounded" (click)="editThumbnail()">
                    <div class="text-white">
                      <i class="ti ti-photo-edit fs-1 mb-2"></i>
                      <div>編輯縮圖</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 隱私設定 -->
              <div class="mb-3">
                <label class="form-label">隱私狀態</label>
                <div *ngIf="!editingPrivacy">
                  <span class="badge badge-lg cursor-pointer" [ngClass]="getPrivacyStatusClass(video.privacyStatus)"
                    (click)="startEditPrivacy()">
                    <i class="ti ti-lock me-1"></i>{{ video.privacyStatus }}
                  </span>
                </div>

                <div *ngIf="editingPrivacy" class="input-group">
                  <select class="form-select" [(ngModel)]="editPrivacy">
                    <option value="Public">公開</option>
                    <option value="Unlisted">不公開列出</option>
                    <option value="Private">私人</option>
                  </select>
                  <button class="btn btn-primary" (click)="savePrivacy()">
                    <i class="ti ti-check"></i>
                  </button>
                  <button class="btn btn-outline-secondary" (click)="cancelEditPrivacy()">
                    <i class="ti ti-x"></i>
                  </button>
                </div>
              </div>

              <hr class="my-3">

              <!-- 處理狀態 -->
              <div class="mb-3">
                <label class="form-label">處理狀態</label>
                <div>
                  <span class="badge badge-lg" [ngClass]="getProcessStatusClass(video.processStatus)">
                    {{ video.processStatus }}
                  </span>
                </div>
              </div>

              <!-- 影片資訊 -->
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label text-muted small">時長</label>
                  <div class="fw-bold">{{ getDuration(video.duration) }}</div>
                </div>
                <div class="col-6">
                  <label class="form-label text-muted small">解析度</label>
                  <div>
                    <span class="badge bg-azure-lt">{{ video.resolution }}</span>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- ===== 基本資訊 ===== -->
          <div class="card mb-4 shadow-sm">
            <div class="card-header">
              <h3 class="card-title">
                <i class="ti ti-info-circle me-2"></i>基本資訊
              </h3>
            </div>
            <div class="card-body">
              <div class="datagrid">
                <div class="datagrid-item">
                  <div class="datagrid-title">頻道 ID</div>
                  <div class="datagrid-content">
                    <code class="text-muted">{{ video.channelId }}</code>
                  </div>
                </div>

                <div class="datagrid-item">
                  <div class="datagrid-title">建立時間</div>
                  <div class="datagrid-content">
                    <i class="ti ti-clock text-muted me-1"></i>
                    {{ video.createdAt | date:'yyyy-MM-dd HH:mm' }}
                  </div>
                </div>

                <div class="datagrid-item">
                  <div class="datagrid-title">更新時間</div>
                  <div class="datagrid-content">
                    <i class="ti ti-refresh text-muted me-1"></i>
                    {{ video.updatedAt | date:'yyyy-MM-dd HH:mm' }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ===== 技術細節 ===== -->
          <div class="card shadow-sm">
            <div class="card-header">
              <h3 class="card-title">
                <i class="ti ti-file-info me-2"></i>技術細節
              </h3>
            </div>
            <div class="card-body">
              <div class="datagrid">
                <div class="datagrid-item">
                  <div class="datagrid-title">檔案大小</div>
                  <div class="datagrid-content">
                    <strong>{{ getReadableSize(video.fileSize) }}</strong>
                  </div>
                </div>

                <div class="datagrid-item">
                  <div class="datagrid-title">解析度</div>
                  <div class="datagrid-content">
                    <span class="badge bg-blue-lt">{{ video.resolution }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>
</div>